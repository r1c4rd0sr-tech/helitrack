<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>HeliTrack Brasil - Helic√≥pteros no Espa√ßo A√©reo Brasileiro</title>
    <!-- Font Awesome para √≠cones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS para mapa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Seu CSS permanece exatamente igual */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        :root {
            --primary: #0066b3;
            --primary-dark: #004c8c;
            --secondary: #ff6b00;
            --accent: #00a896;
            --gray-light: #f5f7fa;
            --gray: #e4e7eb;
            --gray-dark: #6c757d;
            --text-dark: #212529;
            --white: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --border-radius: 12px;
            --brazil-green: #009c3b;
            --brazil-yellow: #ffdf00;
            --brazil-blue: #002776;
        }

        body {
            background-color: #f0f2f5;
            color: var(--text-dark);
            line-height: 1.5;
            padding: 16px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--brazil-green) 0%, var(--brazil-blue) 100%);
            color: white;
            padding: 24px 28px;
            border-radius: var(--border-radius);
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .header::after {
            content: "üáßüá∑";
            position: absolute;
            right: 20px;
            bottom: 10px;
            font-size: 3rem;
            opacity: 0.1;
            transform: rotate(-10deg);
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 600;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            color: var(--brazil-yellow);
            font-size: 2.2rem;
        }

        .badges {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .badge {
            background: rgba(255,255,255,0.15);
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 500;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .badge i {
            color: var(--brazil-yellow);
        }

        /* Cards de estat√≠sticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            background: var(--gray-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.5rem;
        }

        .stat-info h3 {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gray-dark);
            margin-bottom: 4px;
        }

        .stat-info p {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        /* Filtros */
        .filters-section {
            background: var(--white);
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 28px;
        }

        .filters-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 18px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray-dark);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .filter-group select, .filter-group input {
            padding: 12px 14px;
            border: 1px solid var(--gray);
            border-radius: 10px;
            font-size: 0.95rem;
            background: var(--white);
            transition: border 0.2s;
            cursor: pointer;
        }

        .filter-group select:focus, .filter-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0,102,179,0.1);
        }

        .filter-actions {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--gray-light);
            color: var(--text-dark);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(0,102,179,0.3);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: scale(1.02);
        }

        .btn-accent {
            background: var(--accent);
            color: white;
        }

        .btn-accent:hover {
            background: #008577;
        }

        .btn-secondary {
            background: white;
            border: 1px solid var(--gray);
        }

        .btn-secondary:hover {
            background: var(--gray-light);
        }

        /* Datasources indicators */
        .datasources {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 20px 0 10px;
            padding: 12px 0;
            border-top: 1px solid var(--gray);
        }

        .source-tag {
            background: var(--gray-light);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-dark);
            border: 1px solid var(--gray);
        }

        .source-tag i {
            color: var(--secondary);
        }

        .source-tag-live {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .source-tag-live i {
            color: #28a745;
        }

        .source-tag-brazil {
            background: linear-gradient(135deg, #009c3b20, #ffdf0020, #00277620);
            border-color: var(--brazil-blue);
            color: var(--brazil-blue);
            font-weight: 600;
        }

        /* Tabela de resultados */
        .results-section {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .results-header {
            padding: 20px 24px;
            background: var(--gray-light);
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--gray);
        }

        .results-header h2 {
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .view-options {
            display: flex;
            gap: 8px;
            background: white;
            padding: 4px;
            border-radius: 30px;
            border: 1px solid var(--gray);
        }

        .view-option {
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
        }

        .view-option.active {
            background: var(--primary);
            color: white;
        }

        .table-container {
            overflow-x: auto;
            padding: 0 0 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        th {
            text-align: left;
            padding: 16px 20px;
            background: white;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--gray-dark);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 2px solid var(--gray);
        }

        td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray);
            font-size: 0.95rem;
        }

        tr:hover {
            background: var(--gray-light);
        }

        .flight-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-flying {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-ground {
            background: #e2e3e5;
            color: #383d41;
        }

        .airline-logo {
            width: 28px;
            height: 28px;
            background: var(--gray-light);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--primary);
        }

        .brazil-flag {
            display: inline-block;
            margin-left: 5px;
            font-size: 1.2rem;
        }

        .last-update {
            font-size: 0.8rem;
            color: var(--gray-dark);
            margin-left: 10px;
        }

        .live-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #28a745;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.1);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Mapa */
        #map {
            height: 600px;
            width: 100%;
            border-radius: var(--border-radius);
            z-index: 1;
        }

        .map-container {
            padding: 20px;
            display: none;
        }

        .map-controls {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Mobile adjustments */
        @media (max-width: 640px) {
            body {
                padding: 8px;
            }

            .header {
                padding: 18px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .logo h1 {
                font-size: 1.4rem;
            }

            .badges {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .filter-actions {
                flex-direction: column;
                width: 100%;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .results-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            #map {
                height: 400px;
            }
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading i {
            font-size: 2rem;
            color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: var(--gray-dark);
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <h1><i class="fas fa-helicopter"></i> HeliTrack Brasil <span class="live-indicator"></span></h1>
                <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 4px;">üáßüá∑ Helic√≥pteros no espa√ßo a√©reo brasileiro</div>
            </div>
            <div class="badges">
                <span class="badge" id="activeFlightsBadge"><i class="fas fa-satellite-dish"></i> Carregando...</span>
                <span class="badge" id="updateTimeBadge"><i class="fas fa-clock"></i> <span id="lastUpdateTime">-</span></span>
                <span class="badge source-tag-brazil"><i class="fas fa-map-marker-alt"></i> Somente Brasil</span>
            </div>
        </div>

        <!-- Stats cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-helicopter"></i></div>
                <div class="stat-info">
                    <h3>Helic√≥pteros no Brasil</h3>
                    <p id="totalHelicopters">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-map-marker-alt"></i></div>
                <div class="stat-info">
                    <h3>Com posi√ß√£o GPS</h3>
                    <p id="withPosition">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-building"></i></div>
                <div class="stat-info">
                    <h3>Operadoras</h3>
                    <p id="totalOperators">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-arrow-up"></i></div>
                <div class="stat-info">
                    <h3>Em voo</h3>
                    <p id="inFlight">-</p>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filters-section">
            <div class="filters-title">
                <i class="fas fa-sliders-h" style="color: var(--primary);"></i> Filtros - Espa√ßo A√©reo Brasileiro
            </div>
            <div class="filters-grid">
                <div class="filter-group">
                    <label><i class="fas fa-tag"></i> Prefixo / Callsign</label>
                    <input type="text" id="callsignFilter" placeholder="Ex: PR-ABC">
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-plane"></i> Modelo</label>
                    <select id="modelFilter">
                        <option value="">Todos os modelos</option>
                        <option value="AS350">AS350 Esquilo</option>
                        <option value="H145">H145</option>
                        <option value="AW139">AW139</option>
                        <option value="S76">S-76</option>
                        <option value="Bell 407">Bell 407</option>
                        <option value="Bell 429">Bell 429</option>
                        <option value="EC135">EC135</option>
                        <option value="R44">R44 Raven</option>
                        <option value="R66">R66</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-city"></i> Regi√£o</label>
                    <select id="regionFilter">
                        <option value="">Todas as regi√µes</option>
                        <option value="southeast">Sudeste</option>
                        <option value="south">Sul</option>
                        <option value="northeast">Nordeste</option>
                        <option value="north">Norte</option>
                        <option value="centerwest">Centro-Oeste</option>
                        <option value="offshore">Offshore (Plataformas)</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-ruler-vertical"></i> Altitude</label>
                    <select id="altitudeFilter">
                        <option value="all">Todas</option>
                        <option value="ground">Em solo</option>
                        <option value="low">Baixa (at√© 1000 ft)</option>
                        <option value="medium">M√©dia (1000-5000 ft)</option>
                        <option value="high">Alta (>5000 ft)</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-tachometer-alt"></i> Velocidade</label>
                    <select id="speedFilter">
                        <option value="all">Todas</option>
                        <option value="hover">Hover/Parado</option>
                        <option value="slow">Lenta (0-50 kt)</option>
                        <option value="cruise">Cruzeiro (50-120 kt)</option>
                        <option value="fast">R√°pida (>120 kt)</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-bolt"></i> Status</label>
                    <select id="statusFilter">
                        <option value="all">Todos</option>
                        <option value="flying">Em voo</option>
                        <option value="ground">Em solo</option>
                    </select>
                </div>
            </div>

            <div class="filter-actions">
                <button class="btn btn-primary" id="searchBtn"><i class="fas fa-search"></i> Aplicar filtros</button>
                <button class="btn btn-secondary" id="clearBtn"><i class="fas fa-undo-alt"></i> Limpar</button>
                <button class="btn btn-accent" id="refreshBtn"><i class="fas fa-sync-alt"></i> Atualizar dados</button>
            </div>

            <!-- Fontes de dados -->
            <div class="datasources">
                <span class="source-tag source-tag-live"><i class="fas fa-radar"></i> API.market</span>
                <span class="source-tag source-tag-brazil"><i class="fas fa-map-pin"></i> Filtro geogr√°fico Brasil</span>
                <span class="source-tag"><i class="fas fa-database"></i> Dados em tempo real</span>
                <span class="source-tag"><i class="fas fa-chart-line"></i> Atualiza√ß√£o 30s</span>
            </div>
        </div>

        <!-- Resultados -->
        <div class="results-section">
            <div class="results-header">
                <h2><i class="fas fa-list-ul"></i> Helic√≥pteros no Brasil <span id="resultCount">(0)</span></h2>
                <div class="view-options">
                    <button class="view-option active" id="gridViewBtn"><i class="fas fa-table"></i> Tabela</button>
                    <button class="view-option" id="mapViewBtn"><i class="fas fa-map-marked-alt"></i> Mapa</button>
                </div>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <i class="fas fa-circle-notch"></i>
                <p style="margin-top: 10px;">Buscando helic√≥pteros no espa√ßo a√©reo brasileiro...</p>
            </div>

            <!-- Tabela de voos -->
            <div class="table-container" id="tableContainer">
                <table id="flightsTable">
                    <thead>
                        <tr>
                            <th>Prefixo</th>
                            <th>ICAO</th>
                            <th>Modelo</th>
                            <th>Operadora</th>
                            <th>Altitude</th>
                            <th>Velocidade</th>
                            <th>Dire√ß√£o</th>
                            <th>Posi√ß√£o</th>
                            <th>Regi√£o</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="10" style="text-align:center; padding:40px;">
                                <i class="fas fa-helicopter" style="font-size: 2rem; color: var(--gray-dark); margin-bottom: 10px;"></i>
                                <p>Clique em "Atualizar dados" para carregar helic√≥pteros no espa√ßo a√©reo brasileiro</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Mapa -->
            <div id="mapContainer" class="map-container">
                <div id="map"></div>
                <div class="map-controls">
                    <button class="btn btn-secondary" id="fitBrazilBtn"><i class="fas fa-globe-americas"></i> Ver todo Brasil</button>
                    <span class="source-tag source-tag-live"><i class="fas fa-map-pin"></i> <span id="mapMarkersCount">0</span> helic√≥pteros no mapa</span>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>¬© 2025 HeliTrack Brasil - Dados: <a href="#" target="_blank" style="color: var(--primary);">API.market</a> | üáßüá∑ Limitado ao espa√ßo a√©reo brasileiro</p>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        (function() {
            // Configura√ß√µes da API.market
            const API_BASE_URL = 'https://api.market/api/v1'; // URL base da API.market
            const API_KEY = 'cmlmhelc50009jy04el8uhx3o';
            const UPDATE_INTERVAL = 30000; // 30 segundos
            
            // Cache simples para evitar requisi√ß√µes repetidas
            let requestCache = {
                data: null,
                timestamp: null,
                cacheDuration: 10000 // 10 segundos de cache
            };
            
            // Limites geogr√°ficos do Brasil (aproximados)
            const BRAZIL_BOUNDS = {
                minLat: -34.0,  // Sul (Chu√≠)
                maxLat: 5.5,    // Norte (Monte Cabura√≠)
                minLon: -74.0,  // Oeste (Acre)
                maxLon: -34.0   // Leste (Para√≠ba)
            };
            
            // Regi√µes do Brasil (coordenadas aproximadas)
            const REGIONS = {
                southeast: { minLat: -25.5, maxLat: -14.5, minLon: -53.0, maxLon: -39.0, name: 'Sudeste' },
                south: { minLat: -34.0, maxLat: -25.5, minLon: -58.0, maxLon: -48.0, name: 'Sul' },
                northeast: { minLat: -16.0, maxLat: 5.5, minLon: -48.0, maxLon: -34.0, name: 'Nordeste' },
                north: { minLat: -16.0, maxLat: 5.5, minLon: -74.0, maxLon: -48.0, name: 'Norte' },
                centerwest: { minLat: -25.5, maxLat: -16.0, minLon: -62.0, maxLon: -48.0, name: 'Centro-Oeste' },
                offshore: { lat: -22.5, lon: -40.5, radius: 300, name: 'Offshore' } // Bacia de Campos/Santos
            };
            
            // Estado da aplica√ß√£o
            let allHelicopters = [];
            let filteredHelicopters = [];
            let lastUpdate = null;
            let updateTimer = null;
            let map = null;
            let mapMarkers = [];
            
            // Elementos DOM
            const tableBody = document.getElementById('tableBody');
            const resultSpan = document.getElementById('resultCount');
            const loadingEl = document.getElementById('loading');
            const tableContainer = document.getElementById('tableContainer');
            const mapContainer = document.getElementById('mapContainer');
            const lastUpdateSpan = document.getElementById('lastUpdateTime');
            const totalHelicoptersSpan = document.getElementById('totalHelicopters');
            const withPositionSpan = document.getElementById('withPosition');
            const totalOperatorsSpan = document.getElementById('totalOperators');
            const inFlightSpan = document.getElementById('inFlight');
            const activeFlightsBadge = document.getElementById('activeFlightsBadge');
            const mapMarkersCount = document.getElementById('mapMarkersCount');
            
            // Filtros
            const callsignFilter = document.getElementById('callsignFilter');
            const modelFilter = document.getElementById('modelFilter');
            const regionFilter = document.getElementById('regionFilter');
            const altitudeFilter = document.getElementById('altitudeFilter');
            const speedFilter = document.getElementById('speedFilter');
            const statusFilter = document.getElementById('statusFilter');
            
            // Fun√ß√£o para verificar se coordenada est√° no Brasil
            function isInBrazil(lat, lon) {
                if (!lat || !lon) return false;
                return lat >= BRAZIL_BOUNDS.minLat && 
                       lat <= BRAZIL_BOUNDS.maxLat && 
                       lon >= BRAZIL_BOUNDS.minLon && 
                       lon <= BRAZIL_BOUNDS.maxLon;
            }
            
            // Fun√ß√£o para determinar regi√£o do Brasil
            function getRegion(lat, lon) {
                if (!lat || !lon) return 'unknown';
                
                for (const [key, region] of Object.entries(REGIONS)) {
                    if (key === 'offshore') {
                        // Para offshore, calcula dist√¢ncia da Bacia de Campos/Santos
                        const distance = Math.sqrt(
                            Math.pow(lat - region.lat, 2) + 
                            Math.pow(lon - region.lon, 2)
                        ) * 111; // Aproximadamente km por grau
                        if (distance < region.radius) return 'offshore';
                    } else {
                        if (lat >= region.minLat && lat <= region.maxLat && 
                            lon >= region.minLon && lon <= region.maxLon) {
                            return key;
                        }
                    }
                }
                return 'unknown';
            }
            
            // Fun√ß√£o para buscar dados da API.market
            async function fetchHelicopters() {
                try {
                    // Verifica cache
                    const now = Date.now();
                    if (requestCache.data && requestCache.timestamp && 
                        (now - requestCache.timestamp) < requestCache.cacheDuration) {
                        console.log('Usando dados em cache');
                        processHelicopterData(requestCache.data);
                        return;
                    }
                    
                    loadingEl.style.display = 'block';
                    tableContainer.style.opacity = '0.5';
                    
                    // Endpoint espec√≠fico para aeronaves (ajuste conforme documenta√ß√£o da API.market)
                    const response = await fetch(`${API_BASE_URL}/flights`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${API_KEY}`,
                            'Content-Type': 'application/json',
                            'X-API-Key': API_KEY // Algumas APIs usam este formato
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    // Processa os dados recebidos
                    await processHelicopterData(data);
                    
                    // Atualiza cache
                    requestCache.data = data;
                    requestCache.timestamp = Date.now();
                    
                } catch (error) {
                    console.error('Erro ao buscar dados:', error);
                    
                    // Em caso de erro, tenta usar dados mockados para demonstra√ß√£o
                    if (allHelicopters.length === 0) {
                        // Dados mockados para demonstra√ß√£o (apenas se n√£o houver dados reais)
                        const mockData = generateMockData();
                        processHelicopterData(mockData);
                        
                        tableBody.innerHTML = `<tr><td colspan="10" style="text-align:center; padding:20px; color: #856404; background-color: #fff3cd;">
                            <i class="fas fa-info-circle" style="font-size: 1.5rem; margin-bottom: 5px;"></i>
                            <p>Usando dados de demonstra√ß√£o. Erro na API: ${error.message}</p>
                        </td></tr>`;
                    } else {
                        tableBody.innerHTML = `<tr><td colspan="10" style="text-align:center; padding:40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p>Erro ao carregar dados: ${error.message}</p>
                            <p style="margin-top: 10px;"><button class="btn btn-primary" onclick="window.location.reload()">Tentar novamente</button></p>
                        </td></tr>`;
                    }
                } finally {
                    loadingEl.style.display = 'none';
                    tableContainer.style.opacity = '1';
                }
            }
            
            // Processa dados de helic√≥pteros (mapeia campos da API.market)
            function processHelicopterData(data) {
                // Verifica o formato dos dados (adapt√°vel a diferentes estruturas da API)
                let aircrafts = [];
                
                if (Array.isArray(data)) {
                    aircrafts = data;
                } else if (data.aircraft && Array.isArray(data.aircraft)) {
                    aircrafts = data.aircraft;
                } else if (data.flights && Array.isArray(data.flights)) {
                    aircrafts = data.flights;
                } else if (data.data && Array.isArray(data.data)) {
                    aircrafts = data.data;
                } else if (data.results && Array.isArray(data.results)) {
                    aircrafts = data.results;
                } else {
                    // Se n√£o encontrar array, tenta criar um array a partir do objeto
                    console.warn('Formato de dados n√£o reconhecido, tentando adaptar', data);
                    if (typeof data === 'object') {
                        aircrafts = Object.values(data).filter(item => typeof item === 'object');
                    }
                }
                
                // Palavras-chave para identificar helic√≥pteros
                const helicopterKeywords = [
                    'helicopter', 'heli', 'rotor', 'as350', 'h145', 'aw139', 
                    's76', 'bell', 'ec135', 'ec145', 'bk117', 'bo105', 'r44',
                    'r22', 'robinson', 'airbus helicopter', 'airbus helic√≥ptero',
                    'esquilo', 'fennec', 'puma', 'super puma', 'black hawk',
                    'jayhawk', 'seahawk', 'osprey', 'kiowa', 'cayuse',
                    'essa', 'squirrel', 'colibri', 'eurocopter'
                ];
                
                // Mapeia campos da API.market para o formato esperado pelo sistema
                const mappedAircrafts = aircrafts.map(item => ({
                    // Mapeamento de campos (ajuste conforme documenta√ß√£o real da API.market)
                    hex: item.icao24 || item.hex || item.id || Math.random().toString(16).substring(2, 8),
                    flight: item.callsign || item.flight || item.prefixo || 'N/A',
                    t: item.aircraft_type || item.model || item.type || item.t || 'Desconhecido',
                    ownOp: item.operator || item.airline || item.operadora || item.ownOp || 'N/A',
                    lat: item.latitude || item.lat || null,
                    lon: item.longitude || item.lon || null,
                    alt_baro: item.altitude || item.alt_baro || item.alt || 0,
                    gs: item.speed || item.gs || item.velocity || 0,
                    track: item.heading || item.track || item.direction || 0,
                    category: item.category || item.icao_category || '',
                    type: item.aircraft_type || item.type || '',
                    // Mant√©m dados originais para refer√™ncia
                    raw: item
                }));
                
                // Filtra apenas helic√≥pteros
                const helicopters = mappedAircrafts.filter(ac => {
                    // Verifica modelo
                    if (ac.t && ac.t !== 'Desconhecido') {
                        const modelLower = ac.t.toLowerCase();
                        if (helicopterKeywords.some(keyword => modelLower.includes(keyword))) {
                            return true;
                        }
                    }
                    
                    // Verifica prefixo brasileiro de helic√≥ptero
                    if (ac.flight) {
                        const callsign = ac.flight.trim().toUpperCase();
                        if (/^P[RTPU]-\w{3}$/.test(callsign)) {
                            return true;
                        }
                        
                        const heliOperators = ['OMNI', 'LIDER', 'HELI', 'CHC', 'VAST', 'APUI', 'ROTA', 'SARA', 'TAXI AEREO'];
                        if (heliOperators.some(op => callsign.includes(op))) {
                            return true;
                        }
                    }
                    
                    return false;
                });
                
                // Filtra apenas os que est√£o no Brasil (quando t√™m posi√ß√£o)
                const helicoptersInBrazil = helicopters.filter(ac => {
                    if (ac.lat && ac.lon) {
                        return isInBrazil(ac.lat, ac.lon);
                    }
                    // Se n√£o tem posi√ß√£o, mant√©m (podem estar no Brasil)
                    return true;
                });
                
                // Adiciona regi√£o
                helicoptersInBrazil.forEach(ac => {
                    if (ac.lat && ac.lon) {
                        ac.region = getRegion(ac.lat, ac.lon);
                    } else {
                        ac.region = 'unknown';
                    }
                });
                
                allHelicopters = helicoptersInBrazil;
                lastUpdate = new Date();
                
                updateStats();
                applyFilters();
            }
            
            // Gera dados mockados para demonstra√ß√£o (caso a API n√£o retorne dados)
            function generateMockData() {
                const mockHelicopters = [
                    { flight: 'PR-OMN', t: 'AS350 Esquilo', ownOp: 'OMNI', lat: -23.5505, lon: -46.6333, alt_baro: 1500, gs: 120, track: 45 },
                    { flight: 'PT-LDR', t: 'AW139', ownOp: 'LIDER', lat: -22.9068, lon: -43.1729, alt_baro: 2000, gs: 140, track: 90 },
                    { flight: 'PP-CHC', t: 'S-76', ownOp: 'CHC', lat: -25.4284, lon: -49.2733, alt_baro: 1800, gs: 130, track: 270 },
                    { flight: 'PU-VST', t: 'Bell 407', ownOp: 'VAST', lat: -19.9167, lon: -43.9345, alt_baro: 'ground', gs: 0, track: 0 },
                    { flight: 'PR-HLI', t: 'R44 Raven', ownOp: 'HELI', lat: -15.7939, lon: -47.8828, alt_baro: 800, gs: 80, track: 180 },
                    { flight: 'PT-APU', t: 'EC135', ownOp: 'APUI', lat: -30.0346, lon: -51.2177, alt_baro: 1200, gs: 110, track: 60 },
                    { flight: 'PP-RTA', t: 'H145', ownOp: 'ROTA', lat: -8.0476, lon: -34.8770, alt_baro: 2200, gs: 150, track: 320 },
                    { flight: 'PU-SRA', t: 'Bell 429', ownOp: 'SARA', lat: -3.7172, lon: -38.5434, alt_baro: 1400, gs: 125, track: 210 }
                ];
                
                return mockHelicopters.map((h, index) => ({
                    hex: `MOCK${index.toString().padStart(5, '0')}`,
                    ...h
                }));
            }
            
            // Atualiza estat√≠sticas
            function updateStats() {
                const total = allHelicopters.length;
                const withPos = allHelicopters.filter(ac => ac.lat && ac.lon).length;
                const inFlight = allHelicopters.filter(ac => ac.alt_baro && ac.alt_baro !== 'ground' && ac.alt_baro > 0).length;
                
                // Operadoras √∫nicas
                const operators = new Set();
                allHelicopters.forEach(ac => {
                    if (ac.ownOp && ac.ownOp !== 'N/A') operators.add(ac.ownOp);
                    else if (ac.flight) operators.add(ac.flight.substring(0, 4));
                });
                
                totalHelicoptersSpan.textContent = total;
                withPositionSpan.textContent = withPos;
                totalOperatorsSpan.textContent = operators.size || total;
                inFlightSpan.textContent = inFlight;
                
                activeFlightsBadge.innerHTML = `<i class="fas fa-satellite-dish"></i> ${total} helic√≥pteros no Brasil`;
                
                if (lastUpdate) {
                    const timeStr = lastUpdate.toLocaleTimeString('pt-BR');
                    lastUpdateSpan.textContent = timeStr;
                }
            }
            
            // Aplica filtros
            function applyFilters() {
                const callsign = callsignFilter.value.trim().toUpperCase();
                const model = modelFilter.value;
                const region = regionFilter.value;
                const altitude = altitudeFilter.value;
                const speed = speedFilter.value;
                const status = statusFilter.value;
                
                filteredHelicopters = allHelicopters.filter(ac => {
                    // Filtro por callsign
                    if (callsign && (!ac.flight || !ac.flight.toUpperCase().includes(callsign))) {
                        return false;
                    }
                    
                    // Filtro por modelo
                    if (model && (!ac.t || !ac.t.toLowerCase().includes(model.toLowerCase()))) {
                        return false;
                    }
                    
                    // Filtro por regi√£o
                    if (region && region !== 'all' && ac.region !== region) {
                        return false;
                    }
                    
                    // Filtro por altitude
                    let altValue = 0;
                    if (ac.alt_baro && ac.alt_baro !== 'ground') {
                        altValue = parseInt(ac.alt_baro) || 0;
                    }
                    
                    if (altitude === 'ground' && altValue !== 0) return false;
                    if (altitude === 'low' && (altValue <= 0 || altValue > 1000)) return false;
                    if (altitude === 'medium' && (altValue < 1000 || altValue > 5000)) return false;
                    if (altitude === 'high' && altValue < 5000) return false;
                    
                    // Filtro por velocidade
                    const gs = ac.gs || 0;
                    if (speed === 'hover' && gs > 5) return false;
                    if (speed === 'slow' && (gs < 5 || gs > 50)) return false;
                    if (speed === 'cruise' && (gs < 50 || gs > 120)) return false;
                    if (speed === 'fast' && gs < 120) return false;
                    
                    // Filtro por status
                    const isFlying = ac.alt_baro && ac.alt_baro !== 'ground' && ac.alt_baro > 0;
                    if (status === 'flying' && !isFlying) return false;
                    if (status === 'ground' && isFlying) return false;
                    
                    return true;
                });
                
                updateTable();
                updateMap();
            }
            
            // Atualiza tabela com dados filtrados
            function updateTable() {
                tableBody.innerHTML = '';
                resultSpan.textContent = `(${filteredHelicopters.length})`;
                
                if (filteredHelicopters.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:40px;">Nenhum helic√≥ptero encontrado no Brasil com os filtros selecionados.</td></tr>';
                    return;
                }
                
                filteredHelicopters.slice(0, 50).forEach(ac => {
                    const row = document.createElement('tr');
                    
                    const callsign = ac.flight || 'N/A';
                    const icao = ac.hex || 'N/A';
                    const model = ac.t || 'Desconhecido';
                    const operator = ac.ownOp || (ac.flight ? ac.flight.substring(0, 4) : 'N/A');
                    
                    let altitude = 'Em solo';
                    let altClass = '';
                    if (ac.alt_baro && ac.alt_baro !== 'ground' && ac.alt_baro > 0) {
                        altitude = `${ac.alt_baro} ft`;
                        altClass = 'status-flying';
                    }
                    
                    const speed = ac.gs ? `${ac.gs} kt` : 'N/A';
                    const track = ac.track ? `${ac.track}¬∞` : 'N/A';
                    
                    let position = 'N/A';
                    if (ac.lat && ac.lon) {
                        position = `${ac.lat.toFixed(2)}¬∞, ${ac.lon.toFixed(2)}¬∞`;
                    }
                    
                    const region = ac.region !== 'unknown' ? 
                        REGIONS[ac.region]?.name || ac.region : 'N√£o identificada';
                    
                    const status = (ac.alt_baro && ac.alt_baro !== 'ground' && ac.alt_baro > 0) ? 
                        '<span class="flight-status status-flying"><i class="fas fa-helicopter"></i> Em voo</span>' : 
                        '<span class="flight-status status-ground"><i class="fas fa-plane"></i> Em solo</span>';
                    
                    row.innerHTML = `
                        <td><strong>${callsign}</strong></td>
                        <td><code>${icao}</code></td>
                        <td>${model}</td>
                        <td>${operator}</td>
                        <td><span class="${altClass}">${altitude}</span></td>
                        <td>${speed}</td>
                        <td>${track}</td>
                        <td><small>${position}</small></td>
                        <td>${region}</td>
                        <td>${status}</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                if (filteredHelicopters.length > 50) {
                    const more = document.createElement('tr');
                    more.innerHTML = `<td colspan="10" style="text-align:center; background: #f9f9f9;"><i class="fas fa-ellipsis-h"></i> Mais ${filteredHelicopters.length - 50} helic√≥pteros ocultos. Refine os filtros para visualizar.</td>`;
                    tableBody.appendChild(more);
                }
            }
            
            // Inicializa mapa
            function initMap() {
                if (map) return;
                
                map = L.map('map').setView([-14.2350, -51.9253], 4); // Centro do Brasil
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
                
                // Adiciona limite do Brasil
                const bounds = L.latLngBounds(
                    [BRAZIL_BOUNDS.minLat, BRAZIL_BOUNDS.minLon],
                    [BRAZIL_BOUNDS.maxLat, BRAZIL_BOUNDS.maxLon]
                );
                L.rectangle(bounds, {
                    color: "#002776",
                    weight: 2,
                    fill: false,
                    dashArray: '5, 5'
                }).addTo(map).bindTooltip('Espa√ßo A√©reo Brasileiro', { permanent: false });
            }
            
            // Atualiza mapa com marcadores
            function updateMap() {
                if (!map) return;
                
                // Remove marcadores antigos
                mapMarkers.forEach(marker => marker.remove());
                mapMarkers = [];
                
                // Adiciona novos marcadores
                const withPosition = filteredHelicopters.filter(ac => ac.lat && ac.lon);
                mapMarkersCount.textContent = withPosition.length;
                
                withPosition.forEach(ac => {
                    const isFlying = ac.alt_baro && ac.alt_baro !== 'ground' && ac.alt_baro > 0;
                    const icon = L.divIcon({
                        html: `<i class="fas fa-helicopter" style="color: ${isFlying ? '#28a745' : '#6c757d'}; font-size: 20px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);"></i>`,
                        className: 'helicopter-marker',
                        iconSize: [20, 20]
                    });
                    
                    const marker = L.marker([ac.lat, ac.lon], { icon }).addTo(map);
                    
                    const callsign = ac.flight || 'N/A';
                    const model = ac.t || 'Desconhecido';
                    const alt = (ac.alt_baro && ac.alt_baro !== 'ground' && ac.alt_baro > 0) ? `${ac.alt_baro} ft` : 'Em solo';
                    
                    marker.bindPopup(`
                        <b>${callsign}</b><br>
                        Modelo: ${model}<br>
                        Altitude: ${alt}<br>
                        Velocidade: ${ac.gs || 0} kt<br>
                        Operadora: ${ac.ownOp || 'N/A'}<br>
                        <small>ICAO: ${ac.hex}</small>
                    `);
                    
                    mapMarkers.push(marker);
                });
            }
            
            // Event listeners
            document.getElementById('searchBtn').addEventListener('click', applyFilters);
            
            document.getElementById('clearBtn').addEventListener('click', function() {
                callsignFilter.value = '';
                modelFilter.value = '';
                regionFilter.value = '';
                altitudeFilter.value = 'all';
                speedFilter.value = 'all';
                statusFilter.value = 'all';
                applyFilters();
            });
            
            document.getElementById('refreshBtn').addEventListener('click', function() {
                // Limpa cache para for√ßar nova requisi√ß√£o
                requestCache.data = null;
                requestCache.timestamp = null;
                fetchHelicopters();
            });
            
            document.getElementById('fitBrazilBtn').addEventListener('click', function() {
                if (map) {
                    map.setView([-14.2350, -51.9253], 4);
                }
            });
            
            // Troca de visualiza√ß√£o
            document.getElementById('gridViewBtn').addEventListener('click', function() {
                tableContainer.style.display = 'block';
                mapContainer.style.display = 'none';
                document.getElementById('gridViewBtn').classList.add('active');
                document.getElementById('mapViewBtn').classList.remove('active');
            });
            
            document.getElementById('mapViewBtn').addEventListener('click', function() {
                tableContainer.style.display = 'none';
                mapContainer.style.display = 'block';
                document.getElementById('mapViewBtn').classList.add('active');
                document.getElementById('gridViewBtn').classList.remove('active');
                
                if (!map) {
                    initMap();
                    setTimeout(updateMap, 100);
                } else {
                    updateMap();
                }
            });
            
            // Atualiza√ß√£o autom√°tica
            function startAutoUpdate() {
                if (updateTimer) clearInterval(updateTimer);
                updateTimer = setInterval(() => {
                    // Limpa cache para for√ßar nova requisi√ß√£o
                    requestCache.data = null;
                    requestCache.timestamp = null;
                    fetchHelicopters();
                }, UPDATE_INTERVAL);
            }
            
            // Carrega dados iniciais
            fetchHelicopters();
            startAutoUpdate();
            
            // Enter no campo de callsign
            callsignFilter.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') applyFilters();
            });
        })();
    </script>
</body>
</html>