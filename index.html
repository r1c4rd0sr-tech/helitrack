<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>HeliTrack Brasil - HelicÃ³pteros no EspaÃ§o AÃ©reo Brasileiro</title>
    <!-- Font Awesome para Ã­cones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS para mapa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        :root {
            --primary: #0066b3;
            --primary-dark: #004c8c;
            --secondary: #ff6b00;
            --accent: #00a896;
            --gray-light: #f5f7fa;
            --gray: #e4e7eb;
            --gray-dark: #6c757d;
            --text-dark: #212529;
            --white: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --border-radius: 12px;
            --brazil-green: #009c3b;
            --brazil-yellow: #ffdf00;
            --brazil-blue: #002776;
        }

        body {
            background-color: #f0f2f5;
            color: var(--text-dark);
            line-height: 1.5;
            padding: 16px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--brazil-green) 0%, var(--brazil-blue) 100%);
            color: white;
            padding: 24px 28px;
            border-radius: var(--border-radius);
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .header::after {
            content: "ðŸ‡§ðŸ‡·";
            position: absolute;
            right: 20px;
            bottom: 10px;
            font-size: 3rem;
            opacity: 0.1;
            transform: rotate(-10deg);
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 600;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            color: var(--brazil-yellow);
            font-size: 2.2rem;
        }

        .badges {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .badge {
            background: rgba(255,255,255,0.15);
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 500;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .badge i {
            color: var(--brazil-yellow);
        }

        /* Cards de estatÃ­sticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            background: var(--gray-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.5rem;
        }

        .stat-info h3 {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gray-dark);
            margin-bottom: 4px;
        }

        .stat-info p {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        /* Filtros */
        .filters-section {
            background: var(--white);
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 28px;
        }

        .filters-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 18px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray-dark);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .filter-group select, .filter-group input {
            padding: 12px 14px;
            border: 1px solid var(--gray);
            border-radius: 10px;
            font-size: 0.95rem;
            background: var(--white);
            transition: border 0.2s;
            cursor: pointer;
        }

        .filter-group select:focus, .filter-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0,102,179,0.1);
        }

        .filter-actions {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--gray-light);
            color: var(--text-dark);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(0,102,179,0.3);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: scale(1.02);
        }

        .btn-accent {
            background: var(--accent);
            color: white;
        }

        .btn-accent:hover {
            background: #008577;
        }

        .btn-secondary {
            background: white;
            border: 1px solid var(--gray);
        }

        .btn-secondary:hover {
            background: var(--gray-light);
        }

        /* Datasources indicators */
        .datasources {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 20px 0 10px;
            padding: 12px 0;
            border-top: 1px solid var(--gray);
        }

        .source-tag {
            background: var(--gray-light);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-dark);
            border: 1px solid var(--gray);
        }

        .source-tag i {
            color: var(--secondary);
        }

        .source-tag-live {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .source-tag-live i {
            color: #28a745;
        }

        .source-tag-brazil {
            background: linear-gradient(135deg, #009c3b20, #ffdf0020, #00277620);
            border-color: var(--brazil-blue);
            color: var(--brazil-blue);
            font-weight: 600;
        }

        .source-tag-mock {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .source-tag-mock i {
            color: #ffc107;
        }

        /* Tabela de resultados */
        .results-section {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .results-header {
            padding: 20px 24px;
            background: var(--gray-light);
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--gray);
        }

        .results-header h2 {
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .view-options {
            display: flex;
            gap: 8px;
            background: white;
            padding: 4px;
            border-radius: 30px;
            border: 1px solid var(--gray);
        }

        .view-option {
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
        }

        .view-option.active {
            background: var(--primary);
            color: white;
        }

        .table-container {
            overflow-x: auto;
            padding: 0 0 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        th {
            text-align: left;
            padding: 16px 20px;
            background: white;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--gray-dark);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 2px solid var(--gray);
        }

        td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray);
            font-size: 0.95rem;
        }

        tr:hover {
            background: var(--gray-light);
        }

        .flight-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-flying {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-ground {
            background: #e2e3e5;
            color: #383d41;
        }

        .last-update {
            font-size: 0.8rem;
            color: var(--gray-dark);
            margin-left: 10px;
        }

        .live-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #28a745;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.1);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Mapa */
        #map {
            height: 600px;
            width: 100%;
            border-radius: var(--border-radius);
            z-index: 1;
        }

        .map-container {
            padding: 20px;
            display: none;
        }

        .map-controls {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .helicopter-marker {
            background: transparent;
            border: none;
        }

        .helicopter-marker i {
            font-size: 20px;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
        }

        /* Mobile adjustments */
        @media (max-width: 640px) {
            body {
                padding: 8px;
            }

            .header {
                padding: 18px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .logo h1 {
                font-size: 1.4rem;
            }

            .badges {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .filter-actions {
                flex-direction: column;
                width: 100%;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .results-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            #map {
                height: 400px;
            }
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 40px;
            background: var(--white);
            border-radius: var(--border-radius);
        }

        .loading i {
            font-size: 3rem;
            color: var(--primary);
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading p {
            color: var(--gray-dark);
            font-size: 1rem;
        }

        .loading small {
            color: var(--gray-dark);
            font-size: 0.85rem;
            margin-top: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: var(--gray-dark);
            font-size: 0.85rem;
        }
        
        .footer a {
            color: var(--primary);
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }

        .error-message {
            text-align: center;
            padding: 40px;
            color: #721c24;
            background-color: #f8d7da;
            border-radius: var(--border-radius);
            margin: 20px 0;
        }

        .error-message i {
            font-size: 3rem;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <h1><i class="fas fa-helicopter"></i> HeliTrack Brasil <span class="live-indicator"></span></h1>
                <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 4px;">ðŸ‡§ðŸ‡· Monitoramento de helicÃ³pteros em tempo real</div>
            </div>
            <div class="badges">
                <span class="badge" id="activeFlightsBadge"><i class="fas fa-satellite-dish"></i> Carregando...</span>
                <span class="badge" id="updateTimeBadge"><i class="fas fa-clock"></i> <span id="lastUpdateTime">-</span></span>
                <span class="badge source-tag-brazil"><i class="fas fa-map-marker-alt"></i> Somente Brasil</span>
            </div>
        </div>

        <!-- Stats cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-helicopter"></i></div>
                <div class="stat-info">
                    <h3>HelicÃ³pteros</h3>
                    <p id="totalHelicopters">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-map-marker-alt"></i></div>
                <div class="stat-info">
                    <h3>Com posiÃ§Ã£o</h3>
                    <p id="withPosition">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-building"></i></div>
                <div class="stat-info">
                    <h3>Operadoras</h3>
                    <p id="totalOperators">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-arrow-up"></i></div>
                <div class="stat-info">
                    <h3>Em voo</h3>
                    <p id="inFlight">-</p>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filters-section">
            <div class="filters-title">
                <i class="fas fa-sliders-h" style="color: var(--primary);"></i> Filtros
            </div>
            <div class="filters-grid">
                <div class="filter-group">
                    <label><i class="fas fa-tag"></i> Prefixo</label>
                    <input type="text" id="callsignFilter" placeholder="Ex: PR-ABC">
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-plane"></i> Modelo</label>
                    <select id="modelFilter">
                        <option value="">Todos</option>
                        <option value="AS350">AS350 Esquilo</option>
                        <option value="H145">H145</option>
                        <option value="AW139">AW139</option>
                        <option value="S76">S-76</option>
                        <option value="Bell">Bell</option>
                        <option value="EC135">EC135</option>
                        <option value="R44">R44</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-city"></i> RegiÃ£o</label>
                    <select id="regionFilter">
                        <option value="">Todas</option>
                        <option value="southeast">Sudeste</option>
                        <option value="south">Sul</option>
                        <option value="northeast">Nordeste</option>
                        <option value="north">Norte</option>
                        <option value="centerwest">Centro-Oeste</option>
                        <option value="offshore">Offshore</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-ruler-vertical"></i> Altitude</label>
                    <select id="altitudeFilter">
                        <option value="all">Todas</option>
                        <option value="ground">Em solo</option>
                        <option value="low">Baixa (atÃ© 1000 ft)</option>
                        <option value="medium">MÃ©dia (1000-5000 ft)</option>
                        <option value="high">Alta (>5000 ft)</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-bolt"></i> Status</label>
                    <select id="statusFilter">
                        <option value="all">Todos</option>
                        <option value="flying">Em voo</option>
                        <option value="ground">Em solo</option>
                    </select>
                </div>
            </div>

            <div class="filter-actions">
                <button class="btn btn-primary" id="searchBtn"><i class="fas fa-search"></i> Aplicar</button>
                <button class="btn btn-secondary" id="clearBtn"><i class="fas fa-undo-alt"></i> Limpar</button>
                <button class="btn btn-accent" id="refreshBtn"><i class="fas fa-sync-alt"></i> Atualizar</button>
                <button class="btn btn-secondary" id="useMockBtn"><i class="fas fa-database"></i> Usar dados de exemplo</button>
            </div>

            <!-- Fontes de dados -->
            <div class="datasources">
                <span class="source-tag source-tag-live" id="liveSourceTag"><i class="fas fa-radar"></i> API adsb.lol</span>
                <span class="source-tag source-tag-brazil"><i class="fas fa-map-pin"></i> Filtro Brasil</span>
                <span class="source-tag source-tag-mock" id="mockSourceTag" style="display: none;"><i class="fas fa-database"></i> Dados de exemplo</span>
            </div>
        </div>

        <!-- Loading e Resultados -->
        <div id="loadingContainer">
            <div class="loading">
                <i class="fas fa-circle-notch"></i>
                <p>Conectando Ã  API de dados de voo...</p>
                <small>Isso pode levar alguns segundos</small>
            </div>
        </div>

        <div id="resultsSection" class="results-section" style="display: none;">
            <div class="results-header">
                <h2><i class="fas fa-list-ul"></i> HelicÃ³pteros no Brasil <span id="resultCount">(0)</span></h2>
                <div class="view-options">
                    <button class="view-option active" id="gridViewBtn"><i class="fas fa-table"></i> Tabela</button>
                    <button class="view-option" id="mapViewBtn"><i class="fas fa-map-marked-alt"></i> Mapa</button>
                </div>
            </div>

            <!-- Tabela de voos -->
            <div class="table-container" id="tableContainer">
                <table id="flightsTable">
                    <thead>
                        <tr>
                            <th>Prefixo</th>
                            <th>ICAO</th>
                            <th>Modelo</th>
                            <th>Operadora</th>
                            <th>Altitude</th>
                            <th>Velocidade</th>
                            <th>DireÃ§Ã£o</th>
                            <th>PosiÃ§Ã£o</th>
                            <th>RegiÃ£o</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>

            <!-- Mapa -->
            <div id="mapContainer" class="map-container">
                <div id="map"></div>
                <div class="map-controls">
                    <button class="btn btn-secondary" id="fitBrazilBtn"><i class="fas fa-globe-americas"></i> Ver todo Brasil</button>
                    <span class="source-tag source-tag-live"><i class="fas fa-map-pin"></i> <span id="mapMarkersCount">0</span> helicÃ³pteros</span>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Â© 2025 HeliTrack Brasil - <span id="dataSourceText">Conectando...</span> | ðŸ‡§ðŸ‡· EspaÃ§o aÃ©reo brasileiro</p>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        (function() {
            // ConfiguraÃ§Ãµes
            const API_BASE_URL = 'https://api.adsb.lol/v2';
            const UPDATE_INTERVAL = 30000; // 30 segundos
            const USE_CORS_PROXY = true; // Tentar com proxy se necessÃ¡rio
            
            // Limites do Brasil
            const BRAZIL_BOUNDS = {
                minLat: -34.0, maxLat: 5.5, minLon: -74.0, maxLon: -34.0
            };
            
            // RegiÃµes do Brasil
            const REGIONS = {
                southeast: { minLat: -25.5, maxLat: -14.5, minLon: -53.0, maxLon: -39.0, name: 'Sudeste' },
                south: { minLat: -34.0, maxLat: -25.5, minLon: -58.0, maxLon: -48.0, name: 'Sul' },
                northeast: { minLat: -16.0, maxLat: 5.5, minLon: -48.0, maxLon: -34.0, name: 'Nordeste' },
                north: { minLat: -16.0, maxLat: 5.5, minLon: -74.0, maxLon: -48.0, name: 'Norte' },
                centerwest: { minLat: -25.5, maxLat: -16.0, minLon: -62.0, maxLon: -48.0, name: 'Centro-Oeste' },
                offshore: { lat: -22.5, lon: -40.5, radius: 300, name: 'Offshore' }
            };
            
            // Dados mock para fallback
            const MOCK_HELICOPTERS = [
                {
                    flight: 'PR-OMN1',
                    hex: 'E48801',
                    t: 'AS350 Esquilo',
                    ownOp: 'OMNI',
                    alt_baro: 2500,
                    gs: 120,
                    track: 180,
                    lat: -23.5505,
                    lon: -46.6333,
                    region: 'southeast'
                },
                {
                    flight: 'PT-LDR2',
                    hex: 'E48802',
                    t: 'AW139',
                    ownOp: 'LIDER',
                    alt_baro: 4500,
                    gs: 150,
                    track: 90,
                    lat: -22.9068,
                    lon: -43.1729,
                    region: 'southeast'
                },
                {
                    flight: 'PR-HL3',
                    hex: 'E48803',
                    t: 'H145',
                    ownOp: 'HELI',
                    alt_baro: 1800,
                    gs: 130,
                    track: 270,
                    lat: -25.4284,
                    lon: -49.2733,
                    region: 'south'
                },
                {
                    flight: 'PR-CHC4',
                    hex: 'E48804',
                    t: 'S-92',
                    ownOp: 'CHC',
                    alt_baro: 5500,
                    gs: 140,
                    track: 45,
                    lat: -22.5,
                    lon: -40.5,
                    region: 'offshore'
                },
                {
                    flight: 'PT-VST5',
                    hex: 'E48805',
                    t: 'Bell 429',
                    ownOp: 'VAST',
                    alt_baro: 'ground',
                    gs: 0,
                    track: 0,
                    lat: -15.7939,
                    lon: -47.8828,
                    region: 'centerwest'
                },
                {
                    flight: 'PR-APU6',
                    hex: 'E48806',
                    t: 'R44',
                    ownOp: 'APUI',
                    alt_baro: 800,
                    gs: 90,
                    track: 120,
                    lat: -3.7172,
                    lon: -38.5433,
                    region: 'northeast'
                },
                {
                    flight: 'PR-ROT7',
                    hex: 'E48807',
                    t: 'EC135',
                    ownOp: 'ROTA',
                    alt_baro: 1200,
                    gs: 110,
                    track: 200,
                    lat: -30.0346,
                    lon: -51.2177,
                    region: 'south'
                }
            ];
            
            // Estado
            let allHelicopters = [];
            let filteredHelicopters = [];
            let lastUpdate = null;
            let updateTimer = null;
            let map = null;
            let mapMarkers = [];
            let usingMockData = false;
            let dataLoadAttempts = 0;
            const MAX_ATTEMPTS = 2;
            
            // Elementos DOM
            const loadingContainer = document.getElementById('loadingContainer');
            const resultsSection = document.getElementById('resultsSection');
            const tableBody = document.getElementById('tableBody');
            const resultSpan = document.getElementById('resultCount');
            const tableContainer = document.getElementById('tableContainer');
            const mapContainer = document.getElementById('mapContainer');
            const lastUpdateSpan = document.getElementById('lastUpdateTime');
            const totalHelicoptersSpan = document.getElementById('totalHelicopters');
            const withPositionSpan = document.getElementById('withPosition');
            const totalOperatorsSpan = document.getElementById('totalOperators');
            const inFlightSpan = document.getElementById('inFlight');
            const activeFlightsBadge = document.getElementById('activeFlightsBadge');
            const mapMarkersCount = document.getElementById('mapMarkersCount');
            const dataSourceText = document.getElementById('dataSourceText');
            const liveSourceTag = document.getElementById('liveSourceTag');
            const mockSourceTag = document.getElementById('mockSourceTag');
            
            // Filtros
            const callsignFilter = document.getElementById('callsignFilter');
            const modelFilter = document.getElementById('modelFilter');
            const regionFilter = document.getElementById('regionFilter');
            const altitudeFilter = document.getElementById('altitudeFilter');
            const statusFilter = document.getElementById('statusFilter');
            
            // FunÃ§Ãµes de utilidade
            function isInBrazil(lat, lon) {
                if (lat === undefined || lon === undefined || lat === null || lon === null) return false;
                return lat >= BRAZIL_BOUNDS.minLat && lat <= BRAZIL_BOUNDS.maxLat && 
                       lon >= BRAZIL_BOUNDS.minLon && lon <= BRAZIL_BOUNDS.maxLon;
            }
            
            function getRegion(lat, lon) {
                if (!lat || !lon) return 'unknown';
                for (const [key, region] of Object.entries(REGIONS)) {
                    if (key === 'offshore') {
                        const distance = Math.sqrt(Math.pow(lat - region.lat, 2) + Math.pow(lon - region.lon, 2)) * 111;
                        if (distance < region.radius) return 'offshore';
                    } else {
                        if (lat >= region.minLat && lat <= region.maxLat && lon >= region.minLon && lon <= region.maxLon) {
                            return key;
                        }
                    }
                }
                return 'unknown';
            }
            
            function isHelicopter(ac) {
                const helicopterModels = ['as350', 'h145', 'aw139', 's76', 'bell', 'ec135', 'r44', 'r66', 'robinson', 'airbus', 'eurocopter'];
                if (ac.t) {
                    const model = ac.t.toLowerCase();
                    if (helicopterModels.some(m => model.includes(m))) return true;
                }
                if (ac.flight) {
                    const callsign = ac.flight.toUpperCase();
                    if (/^P[RTPU]-\w{3,4}$/.test(callsign)) return true;
                }
                return false;
            }
            
            // Carregar dados mock
            function loadMockData() {
                console.log('Carregando dados de exemplo...');
                usingMockData = true;
                
                // Atualizar UI para indicar modo mock
                if (liveSourceTag) liveSourceTag.style.display = 'none';
                if (mockSourceTag) mockSourceTag.style.display = 'inline-flex';
                if (dataSourceText) dataSourceText.textContent = 'Dados de exemplo (modo demonstraÃ§Ã£o)';
                
                // Processar dados mock
                allHelicopters = MOCK_HELICOPTERS.map(ac => ({
                    ...ac,
                    region: ac.region || getRegion(ac.lat, ac.lon)
                }));
                
                lastUpdate = new Date();
                loadingContainer.style.display = 'none';
                resultsSection.style.display = 'block';
                
                updateStats();
                applyFilters();
            }
            
            // Buscar dados da API com proxy CORS se necessÃ¡rio
            async function fetchWithProxy(url) {
                if (USE_CORS_PROXY) {
                    // Tenta com proxy CORS gratuito
                    const proxyUrls = [
                        'https://cors-anywhere.herokuapp.com/',
                        'https://api.allorigins.win/raw?url='
                    ];
                    
                    for (const proxy of proxyUrls) {
                        try {
                            console.log(`Tentando com proxy: ${proxy}`);
                            const response = await fetch(proxy + encodeURIComponent(url), {
                                timeout: 5000
                            });
                            if (response.ok) return response;
                        } catch (e) {
                            console.log(`Proxy ${proxy} falhou`);
                        }
                    }
                }
                
                // Tenta sem proxy
                return await fetch(url);
            }
            
            // Buscar dados da API
            async function fetchHelicopters() {
                try {
                    dataLoadAttempts++;
                    
                    const apiUrl = `${API_BASE_URL}/aircraft/`;
                    console.log(`Tentativa ${dataLoadAttempts}: Buscando ${apiUrl}`);
                    
                    const response = await fetchWithProxy(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data?.aircraft || !Array.isArray(data.aircraft)) {
                        throw new Error('Dados invÃ¡lidos');
                    }
                    
                    console.log(`Recebidas ${data.aircraft.length} aeronaves`);
                    
                    // Filtrar helicÃ³pteros no Brasil
                    const helicopters = data.aircraft
                        .filter(ac => isHelicopter(ac))
                        .filter(ac => {
                            if (ac.lat && ac.lon) {
                                return isInBrazil(ac.lat, ac.lon);
                            }
                            return true;
                        })
                        .map(ac => ({
                            ...ac,
                            region: ac.lat && ac.lon ? getRegion(ac.lat, ac.lon) : 'unknown'
                        }));
                    
                    console.log(`${helicopters.length} helicÃ³pteros no Brasil`);
                    
                    if (helicopters.length === 0 && dataLoadAttempts < MAX_ATTEMPTS) {
                        // Se nÃ£o encontrou helicÃ³pteros, tenta novamente
                        setTimeout(fetchHelicopters, 2000);
                        return;
                    }
                    
                    allHelicopters = helicopters;
                    usingMockData = false;
                    
                    // Atualizar UI para modo live
                    if (liveSourceTag) liveSourceTag.style.display = 'inline-flex';
                    if (mockSourceTag) mockSourceTag.style.display = 'none';
                    if (dataSourceText) dataSourceText.textContent = 'Dados em tempo real via adsb.lol';
                    
                    lastUpdate = new Date();
                    loadingContainer.style.display = 'none';
                    resultsSection.style.display = 'block';
                    
                    updateStats();
                    applyFilters();
                    
                    dataLoadAttempts = 0;
                    
                } catch (error) {
                    console.error('Erro na API:', error);
                    
                    if (dataLoadAttempts < MAX_ATTEMPTS) {
                        console.log(`Tentativa ${dataLoadAttempts} falhou, tentando novamente...`);
                        setTimeout(fetchHelicopters, 2000);
                    } else {
                        console.log('MÃ¡ximo de tentativas atingido, usando dados mock');
                        loadMockData();
                    }
                }
            }
            
            // Atualizar estatÃ­sticas
            function updateStats() {
                const total = allHelicopters.length;
                const withPos = allHelicopters.filter(ac => ac.lat && ac.lon).length;
                const inFlight = allHelicopters.filter(ac => ac.alt_baro && ac.alt_baro !== 'ground' && ac.alt_baro !== 0).length;
                const operators = new Set(allHelicopters.map(ac => ac.ownOp || (ac.flight?.substring(0, 4)) || 'N/A'));
                
                if (totalHelicoptersSpan) totalHelicoptersSpan.textContent = total;
                if (withPositionSpan) withPositionSpan.textContent = withPos;
                if (totalOperatorsSpan) totalOperatorsSpan.textContent = operators.size;
                if (inFlightSpan) inFlightSpan.textContent = inFlight;
                
                if (activeFlightsBadge) {
                    if (usingMockData) {
                        activeFlightsBadge.innerHTML = `<i class="fas fa-database"></i> ${total} (modo exemplo)`;
                    } else {
                        activeFlightsBadge.innerHTML = `<i class="fas fa-satellite-dish"></i> ${total} ativos`;
                    }
                }
                
                if (lastUpdate && lastUpdateSpan) {
                    lastUpdateSpan.textContent = lastUpdate.toLocaleTimeString('pt-BR');
                }
            }
            
            // Aplicar filtros
            function applyFilters() {
                const callsign = callsignFilter?.value.trim().toUpperCase() || '';
                const model = modelFilter?.value || '';
                const region = regionFilter?.value || '';
                const altitude = altitudeFilter?.value || 'all';
                const status = statusFilter?.value || 'all';
                
                filteredHelicopters = allHelicopters.filter(ac => {
                    if (callsign && (!ac.flight || !ac.flight.toUpperCase().includes(callsign))) return false;
                    if (model && (!ac.t || !ac.t.toLowerCase().includes(model.toLowerCase()))) return false;
                    if (region && ac.region !== region) return false;
                    
                    const alt = ac.alt_baro && ac.alt_baro !== 'ground' ? parseInt(ac.alt_baro) : 0;
                    if (altitude === 'ground' && alt !== 0) return false;
                    if (altitude === 'low' && (alt <= 0 || alt > 1000)) return false;
                    if (altitude === 'medium' && (alt < 1000 || alt > 5000)) return false;
                    if (altitude === 'high' && alt < 5000) return false;
                    
                    const isFlying = ac.alt_baro && ac.alt_baro !== 'ground' && ac.alt_baro !== 0;
                    if (status === 'flying' && !isFlying) return false;
                    if (status === 'ground' && isFlying) return false;
                    
                    return true;
                });
                
                updateTable();
                if (map && mapContainer.style.display === 'block') {
                    updateMap();
                }
            }
            
            // Atualizar tabela
            function updateTable() {
                if (!tableBody || !resultSpan) return;
                
                tableBody.innerHTML = '';
                resultSpan.textContent = `(${filteredHelicopters.length})`;
                
                if (filteredHelicopters.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:40px;">Nenhum helicÃ³ptero encontrado com os filtros selecionados.</td></tr>';
                    return;
                }
                
                filteredHelicopters.slice(0, 50).forEach(ac => {
                    const row = document.createElement('tr');
                    
                    const callsign = ac.flight || 'N/A';
                    const icao = ac.hex || 'N/A';
                    const model = ac.t || 'Desconhecido';
                    const operator = ac.ownOp || (ac.flight ? ac.flight.substring(0, 4) : 'N/A');
                    
                    let altitude = 'Em solo';
                    if (ac.alt_baro && ac.alt_baro !== 'ground' && ac.alt_baro !== 0) {
                        altitude = `${ac.alt_baro} ft`;
                    }
                    
                    const speed = ac.gs ? `${ac.gs} kt` : 'N/A';
                    const track = ac.track ? `${ac.track}Â°` : 'N/A';
                    
                    let position = 'N/A';
                    if (ac.lat && ac.lon) {
                        position = `${ac.lat.toFixed(2)}Â°, ${ac.lon.toFixed(2)}Â°`;
                    }
                    
                    const region = REGIONS[ac.region]?.name || ac.region || 'NÃ£o identificada';
                    
                    const isFlying = ac.alt_baro && ac.alt_baro !== 'ground' && ac.alt_baro !== 0;
                    const statusClass = isFlying ? 'status-flying' : 'status-ground';
                    const statusIcon = isFlying ? 'fa-helicopter' : 'fa-circle';
                    const statusText = isFlying ? 'Em voo' : 'Em solo';
                    
                    row.innerHTML = `
                        <td><strong>${callsign}</strong></td>
                        <td><code>${icao}</code></td>
                        <td>${model}</td>
                        <td>${operator}</td>
                        <td>${altitude}</td>
                        <td>${speed}</td>
                        <td>${track}</td>
                        <td><small>${position}</small></td>
                        <td>${region}</td>
                        <td><span class="flight-status ${statusClass}"><i class="fas ${statusIcon}"></i> ${statusText}</span></td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            }
            
            // Inicializar mapa
            function initMap() {
                if (map) return;
                
                try {
                    map = L.map('map').setView([-14.2350, -51.9253], 4);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Â© OpenStreetMap'
                    }).addTo(map);
                    
                    L.rectangle(
                        [[BRAZIL_BOUNDS.minLat, BRAZIL_BOUNDS.minLon], [BRAZIL_BOUNDS.maxLat, BRAZIL_BOUNDS.maxLon]],
                        { color: "#002776", weight: 2, fill: false, dashArray: '5,5' }
                    ).addTo(map);
                    
                } catch (error) {
                    console.error('Erro no mapa:', error);
                }
            }
            
            // Atualizar mapa
            function updateMap() {
                if (!map) return;
                
                mapMarkers.forEach(m => m.remove());
                mapMarkers = [];
                
                const withPosition = filteredHelicopters.filter(ac => ac.lat && ac.lon);
                if (mapMarkersCount) mapMarkersCount.textContent = withPosition.length;
                
                withPosition.forEach(ac => {
                    const isFlying = ac.alt_baro && ac.alt_baro !== 'ground' && ac.alt_baro !== 0;
                    
                    const icon = L.divIcon({
                        html: `<i class="fas fa-helicopter" style="color: ${isFlying ? '#28a745' : '#6c757d'}; font-size: 20px; text-shadow: 0 0 3px white;"></i>`,
                        className: 'helicopter-marker',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });
                    
                    const marker = L.marker([ac.lat, ac.lon], { icon }).addTo(map);
                    
                    marker.bindPopup(`
                        <b>${ac.flight || 'N/A'}</b><br>
                        Modelo: ${ac.t || 'Desconhecido'}<br>
                        Altitude: ${ac.alt_baro && ac.alt_baro !== 'ground' ? ac.alt_baro + ' ft' : 'Em solo'}<br>
                        Velocidade: ${ac.gs || 0} kt<br>
                        Operadora: ${ac.ownOp || 'N/A'}
                    `);
                    
                    mapMarkers.push(marker);
                });
            }
            
            // Event listeners
            document.addEventListener('DOMContentLoaded', function() {
                // BotÃµes
                document.getElementById('searchBtn')?.addEventListener('click', applyFilters);
                document.getElementById('clearBtn')?.addEventListener('click', () => {
                    if (callsignFilter) callsignFilter.value = '';
                    if (modelFilter) modelFilter.value = '';
                    if (regionFilter) regionFilter.value = '';
                    if (altitudeFilter) altitudeFilter.value = 'all';
                    if (statusFilter) statusFilter.value = 'all';
                    applyFilters();
                });
                
                document.getElementById('refreshBtn')?.addEventListener('click', () => {
                    dataLoadAttempts = 0;
                    loadingContainer.style.display = 'flex';
                    resultsSection.style.display = 'none';
                    fetchHelicopters();
                });
                
                document.getElementById('useMockBtn')?.addEventListener('click', loadMockData);
                
                document.getElementById('fitBrazilBtn')?.addEventListener('click', () => {
                    if (map) map.setView([-14.2350, -51.9253], 4);
                });
                
                // Toggle visualizaÃ§Ã£o
                document.getElementById('gridViewBtn')?.addEventListener('click', function() {
                    tableContainer.style.display = 'block';
                    mapContainer.style.display = 'none';
                    this.classList.add('active');
                    document.getElementById('mapViewBtn').classList.remove('active');
                });
                
                document.getElementById('mapViewBtn')?.addEventListener('click', function() {
                    tableContainer.style.display = 'none';
                    mapContainer.style.display = 'block';
                    this.classList.add('active');
                    document.getElementById('gridViewBtn').classList.remove('active');
                    
                    if (!map) {
                        initMap();
                        setTimeout(updateMap, 300);
                    } else {
                        updateMap();
                    }
                });
                
                // Enter no filtro
                callsignFilter?.addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') applyFilters();
                });
            });
            
            // Iniciar
            fetchHelicopters();
            setInterval(() => {
                if (!usingMockData) {
                    fetchHelicopters();
                }
            }, UPDATE_INTERVAL);
            
        })();
    </script>
</body>
</html>