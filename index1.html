<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeliTrack Brasil - OpenSky Network</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* ... Seus estilos originais ... */
        .source-tag-opensky { background: #e3f2fd; border-color: #2196f3; color: #0d47a1; }
    </style>
</head>
<body>
    <div class="datasources">
        <span class="source-tag source-tag-opensky"><i class="fas fa-satellite"></i> OpenSky Network API</span>
        <span class="source-tag source-tag-live"><i class="fas fa-sync"></i> Atualização em tempo real</span>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        (function() {
            // Configurações OpenSky Network
            // Bounding Box aproximado do Brasil: [minLat, minLon, maxLat, maxLon]
            const BRAZIL_BBOX = { lamin: -33.75, lomin: -73.98, lamax: 5.27, lomax: -34.79 };
            const OPENSKY_URL = 'https://opensky-network.org/api/states/all';

            let allFlights = [];
            let map = null;
            let markersLayer = L.layerGroup();

            // Inicializar Mapa
            function initMap() {
                map = L.map('map').setView([-15.78, -47.93], 4);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                markersLayer.addTo(map);
            }

            // Mapeamento de categorias da OpenSky
            // Categoria 3 e 4 geralmente referem-se a helicópteros em alguns contextos, 
            // mas a OpenSky usa 'callsign' e 'icao24' para identificação precisa.
            async function fetchHelicopters() {
                const loadingEl = document.getElementById('loading');
                const tableBody = document.getElementById('tableBody');
                
                loadingEl.style.display = 'block';
                
                try {
                    // Chamada filtrada geograficamente para o Brasil (economiza banda)
                    const url = `${OPENSKY_URL}?lamin=${BRAZIL_BBOX.lamin}&lomin=${BRAZIL_BBOX.lomin}&lamax=${BRAZIL_BBOX.lamax}&lomax=${BRAZIL_BBOX.lomax}`;
                    
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Erro na API OpenSky');
                    
                    const data = await response.json();
                    
                    // Estrutura do State Vector da OpenSky:
                    // [0] icao24, [1] callsign, [2] origin_country, [5] longitude, [6] latitude, [7] baro_altitude, [9] velocity, [10] true_track, [11] vertical_rate
                    
                    // Filtragem por prefixos brasileiros (PT, PR, PP, PS, PU) 
                    // e lógica de callsign comum em helicópteros
                    allFlights = (data.states || []).filter(state => {
                        const callsign = (state[1] || "").trim();
                        // Filtra aeronaves registradas no Brasil ou com prefixo brasileiro
                        return state[2] === "Brazil" || /^(PT|PR|PP|PS|PU)/.test(callsign);
                    }).map(state => ({
                        icao: state[0],
                        callsign: state[1] || "N/A",
                        lon: state[5],
                        lat: state[6],
                        alt: state[7] ? Math.round(state[7] * 3.28084) : 0, // Metros para Pés
                        speed: state[9] ? Math.round(state[9] * 1.94384) : 0, // m/s para Nós
                        heading: state[10] || 0,
                        onGround: state[8]
                    }));

                    updateUI();
                } catch (error) {
                    console.error("Erro ao buscar dados:", error);
                    tableBody.innerHTML = `<tr><td colspan="10" style="text-align:center; color:red;">Erro ao conectar com OpenSky Network.</td></tr>`;
                } finally {
                    loadingEl.style.display = 'none';
                }
            }

            function updateUI() {
                const tableBody = document.getElementById('tableBody');
                tableBody.innerHTML = "";
                markersLayer.clearLayers();

                document.getElementById('totalHelicopters').innerText = allFlights.length;
                document.getElementById('resultCount').innerText = `(${allFlights.length})`;
                document.getElementById('lastUpdateTime').innerText = new Date().toLocaleTimeString();

                allFlights.forEach(flight => {
                    // Adicionar na Tabela
                    const row = `
                        <tr>
                            <td><strong>${flight.callsign}</strong></td>
                            <td>${flight.icao.toUpperCase()}</td>
                            <td>Helicóptero*</td>
                            <td>-</td>
                            <td>${flight.alt} ft</td>
                            <td>${flight.speed} kt</td>
                            <td>${flight.heading}°</td>
                            <td>${flight.lat.toFixed(2)}, ${flight.lon.toFixed(2)}</td>
                            <td>Brasil</td>
                            <td><span class="flight-status ${flight.onGround ? 'status-ground' : 'status-flying'}">
                                ${flight.onGround ? 'SOLO' : 'EM VOO'}
                            </span></td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;

                    // Adicionar no Mapa
                    if (flight.lat && flight.lon) {
                        L.marker([flight.lat, flight.lon])
                         .bindPopup(`<b>${flight.callsign}</b><br>Alt: ${flight.alt}ft<br>Vel: ${flight.speed}kt`)
                         .addTo(markersLayer);
                    }
                });
            }

            // Eventos
            document.getElementById('refreshBtn').addEventListener('click', fetchHelicopters);
            document.getElementById('mapViewBtn').addEventListener('click', () => {
                document.getElementById('tableContainer').style.display = 'none';
                document.getElementById('mapContainer').style.display = 'block';
                setTimeout(() => map.invalidateSize(), 200);
            });
            document.getElementById('gridViewBtn').addEventListener('click', () => {
                document.getElementById('tableContainer').style.display = 'block';
                document.getElementById('mapContainer').style.display = 'none';
            });

            // Init
            initMap();
            fetchHelicopters();
        })();
    </script>
</body>
</html>