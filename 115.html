<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>HeliTrack Brasil - Helic√≥pteros no Espa√ßo A√©reo Brasileiro</title>
    <!-- Font Awesome para √≠cones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS para mapa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* [MANTENHA TODOS OS ESTILOS EXISTENTES AQUI - N√£o vou repetir para economizar espa√ßo] */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        :root {
            --primary: #0066b3;
            --primary-dark: #004c8c;
            --secondary: #ff6b00;
            --accent: #00a896;
            --gray-light: #f5f7fa;
            --gray: #e4e7eb;
            --gray-dark: #6c757d;
            --text-dark: #212529;
            --white: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --border-radius: 12px;
            --brazil-green: #009c3b;
            --brazil-yellow: #ffdf00;
            --brazil-blue: #002776;
        }

        body {
            background-color: #f0f2f5;
            color: var(--text-dark);
            line-height: 1.5;
            padding: 16px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--brazil-green) 0%, var(--brazil-blue) 100%);
            color: white;
            padding: 24px 28px;
            border-radius: var(--border-radius);
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .header::after {
            content: "üáßüá∑";
            position: absolute;
            right: 20px;
            bottom: 10px;
            font-size: 3rem;
            opacity: 0.1;
            transform: rotate(-10deg);
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 600;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            color: var(--brazil-yellow);
            font-size: 2.2rem;
        }

        .badges {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .badge {
            background: rgba(255,255,255,0.15);
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 500;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .badge i {
            color: var(--brazil-yellow);
        }

        /* Cards de estat√≠sticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            background: var(--gray-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.5rem;
        }

        .stat-info h3 {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gray-dark);
            margin-bottom: 4px;
        }

        .stat-info p {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        /* Filtros */
        .filters-section {
            background: var(--white);
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 28px;
        }

        .filters-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 18px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray-dark);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .filter-group select, .filter-group input {
            padding: 12px 14px;
            border: 1px solid var(--gray);
            border-radius: 10px;
            font-size: 0.95rem;
            background: var(--white);
            transition: border 0.2s;
            cursor: pointer;
        }

        .filter-group select:focus, .filter-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0,102,179,0.1);
        }

        .filter-actions {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--gray-light);
            color: var(--text-dark);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(0,102,179,0.3);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: scale(1.02);
        }

        .btn-accent {
            background: var(--accent);
            color: white;
        }

        .btn-accent:hover {
            background: #008577;
        }

        .btn-secondary {
            background: white;
            border: 1px solid var(--gray);
        }

        .btn-secondary:hover {
            background: var(--gray-light);
        }

        /* Datasources indicators */
        .datasources {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 20px 0 10px;
            padding: 12px 0;
            border-top: 1px solid var(--gray);
        }

        .source-tag {
            background: var(--gray-light);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-dark);
            border: 1px solid var(--gray);
        }

        .source-tag i {
            color: var(--secondary);
        }

        .source-tag-live {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .source-tag-live i {
            color: #28a745;
        }

        .source-tag-brazil {
            background: linear-gradient(135deg, #009c3b20, #ffdf0020, #00277620);
            border-color: var(--brazil-blue);
            color: var(--brazil-blue);
            font-weight: 600;
        }

        /* Tabela de resultados */
        .results-section {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .results-header {
            padding: 20px 24px;
            background: var(--gray-light);
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--gray);
        }

        .results-header h2 {
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .view-options {
            display: flex;
            gap: 8px;
            background: white;
            padding: 4px;
            border-radius: 30px;
            border: 1px solid var(--gray);
        }

        .view-option {
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
        }

        .view-option.active {
            background: var(--primary);
            color: white;
        }

        .table-container {
            overflow-x: auto;
            padding: 0 0 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        th {
            text-align: left;
            padding: 16px 20px;
            background: white;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--gray-dark);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 2px solid var(--gray);
        }

        td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray);
            font-size: 0.95rem;
        }

        tr:hover {
            background: var(--gray-light);
        }

        .flight-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-flying {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-ground {
            background: #e2e3e5;
            color: #383d41;
        }

        .airline-logo {
            width: 28px;
            height: 28px;
            background: var(--gray-light);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--primary);
        }

        .brazil-flag {
            display: inline-block;
            margin-left: 5px;
            font-size: 1.2rem;
        }

        .last-update {
            font-size: 0.8rem;
            color: var(--gray-dark);
            margin-left: 10px;
        }

        .live-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #28a745;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.1);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Mapa */
        #map {
            height: 600px;
            width: 100%;
            border-radius: var(--border-radius);
            z-index: 1;
        }

        .map-container {
            padding: 20px;
            display: none;
        }

        .map-controls {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Mobile adjustments */
        @media (max-width: 640px) {
            body {
                padding: 8px;
            }

            .header {
                padding: 18px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .logo h1 {
                font-size: 1.4rem;
            }

            .badges {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .filter-actions {
                flex-direction: column;
                width: 100%;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .results-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            #map {
                height: 400px;
            }
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading i {
            font-size: 2rem;
            color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: var(--gray-dark);
            font-size: 0.85rem;
        }
        
        /* Indicador de conex√£o com a API */
        .api-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-left: 15px;
            font-size: 0.8rem;
            background: rgba(0,0,0,0.2);
            padding: 3px 10px;
            border-radius: 20px;
        }
        
        .api-status.connected {
            color: #a8e6cf;
        }
        
        .api-status.error {
            color: #ff8a8a;
        }
        
        .credit-badge {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <h1><i class="fas fa-helicopter"></i> HeliTrack Brasil <span class="live-indicator"></span></h1>
                <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 4px;">üáßüá∑ Helic√≥pteros no espa√ßo a√©reo brasileiro</div>
            </div>
            <div class="badges">
                <span class="badge" id="activeFlightsBadge"><i class="fas fa-satellite-dish"></i> Carregando...</span>
                <span class="badge" id="updateTimeBadge"><i class="fas fa-clock"></i> <span id="lastUpdateTime">-</span></span>
                <span class="badge source-tag-brazil"><i class="fas fa-map-marker-alt"></i> Somente Brasil</span>
                <span class="badge api-status" id="apiStatus"><i class="fas fa-wifi"></i> Conectando...</span>
            </div>
        </div>

        <!-- Stats cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-helicopter"></i></div>
                <div class="stat-info">
                    <h3>Helic√≥pteros no Brasil</h3>
                    <p id="totalHelicopters">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-map-marker-alt"></i></div>
                <div class="stat-info">
                    <h3>Com posi√ß√£o GPS</h3>
                    <p id="withPosition">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-building"></i></div>
                <div class="stat-info">
                    <h3>Operadoras</h3>
                    <p id="totalOperators">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-arrow-up"></i></div>
                <div class="stat-info">
                    <h3>Em voo</h3>
                    <p id="inFlight">-</p>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filters-section">
            <div class="filters-title">
                <i class="fas fa-sliders-h" style="color: var(--primary);"></i> Filtros - Espa√ßo A√©reo Brasileiro
            </div>
            <div class="filters-grid">
                <div class="filter-group">
                    <label><i class="fas fa-tag"></i> Prefixo / Callsign</label>
                    <input type="text" id="callsignFilter" placeholder="Ex: PR-ABC">
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-plane"></i> Modelo</label>
                    <select id="modelFilter">
                        <option value="">Todos os modelos</option>
                        <option value="AS350">AS350 Esquilo</option>
                        <option value="H145">H145</option>
                        <option value="AW139">AW139</option>
                        <option value="S76">S-76</option>
                        <option value="Bell 407">Bell 407</option>
                        <option value="Bell 429">Bell 429</option>
                        <option value="EC135">EC135</option>
                        <option value="R44">R44 Raven</option>
                        <option value="R66">R66</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-city"></i> Regi√£o</label>
                    <select id="regionFilter">
                        <option value="">Todas as regi√µes</option>
                        <option value="southeast">Sudeste</option>
                        <option value="south">Sul</option>
                        <option value="northeast">Nordeste</option>
                        <option value="north">Norte</option>
                        <option value="centerwest">Centro-Oeste</option>
                        <option value="offshore">Offshore (Plataformas)</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-ruler-vertical"></i> Altitude</label>
                    <select id="altitudeFilter">
                        <option value="all">Todas</option>
                        <option value="ground">Em solo</option>
                        <option value="low">Baixa (at√© 1000 ft)</option>
                        <option value="medium">M√©dia (1000-5000 ft)</option>
                        <option value="high">Alta (>5000 ft)</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-tachometer-alt"></i> Velocidade</label>
                    <select id="speedFilter">
                        <option value="all">Todas</option>
                        <option value="hover">Hover/Parado</option>
                        <option value="slow">Lenta (0-50 kt)</option>
                        <option value="cruise">Cruzeiro (50-120 kt)</option>
                        <option value="fast">R√°pida (>120 kt)</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-bolt"></i> Status</label>
                    <select id="statusFilter">
                        <option value="all">Todos</option>
                        <option value="flying">Em voo</option>
                        <option value="ground">Em solo</option>
                    </select>
                </div>
            </div>

            <div class="filter-actions">
                <button class="btn btn-primary" id="searchBtn"><i class="fas fa-search"></i> Aplicar filtros</button>
                <button class="btn btn-secondary" id="clearBtn"><i class="fas fa-undo-alt"></i> Limpar</button>
                <button class="btn btn-accent" id="refreshBtn"><i class="fas fa-sync-alt"></i> Atualizar dados</button>
            </div>

            <!-- Fontes de dados -->
            <div class="datasources">
                <span class="source-tag source-tag-live"><i class="fas fa-radar"></i> RapidAPI (ADS-B Exchange)</span>
                <span class="source-tag source-tag-brazil"><i class="fas fa-map-pin"></i> Filtro geogr√°fico Brasil</span>
                <span class="source-tag"><i class="fas fa-database"></i> Dados em tempo real</span>
                <span class="source-tag"><i class="fas fa-chart-line"></i> Atualiza√ß√£o 30s</span>
            </div>
            
            <!-- Cr√©ditos da API -->
            <div class="credit-badge">
                <i class="fas fa-code-branch"></i> Dados fornecidos por: default-application_11568714 via RapidAPI
            </div>
        </div>

        <!-- Resultados -->
        <div class="results-section">
            <div class="results-header">
                <h2><i class="fas fa-list-ul"></i> Helic√≥pteros no Brasil <span id="resultCount">(0)</span></h2>
                <div class="view-options">
                    <button class="view-option active" id="gridViewBtn"><i class="fas fa-table"></i> Tabela</button>
                    <button class="view-option" id="mapViewBtn"><i class="fas fa-map-marked-alt"></i> Mapa</button>
                </div>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <i class="fas fa-circle-notch"></i>
                <p style="margin-top: 10px;">Buscando helic√≥pteros no espa√ßo a√©reo brasileiro via RapidAPI...</p>
            </div>

            <!-- Tabela de voos -->
            <div class="table-container" id="tableContainer">
                <table id="flightsTable">
                    <thead>
                        <tr>
                            <th>Prefixo</th>
                            <th>ICAO</th>
                            <th>Modelo</th>
                            <th>Operadora</th>
                            <th>Altitude</th>
                            <th>Velocidade</th>
                            <th>Dire√ß√£o</th>
                            <th>Posi√ß√£o</th>
                            <th>Regi√£o</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="10" style="text-align:center; padding:40px;">
                                <i class="fas fa-helicopter" style="font-size: 2rem; color: var(--gray-dark); margin-bottom: 10px;"></i>
                                <p>Clique em "Atualizar dados" para carregar helic√≥pteros no espa√ßo a√©reo brasileiro via RapidAPI</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Mapa -->
            <div id="mapContainer" class="map-container">
                <div id="map"></div>
                <div class="map-controls">
                    <button class="btn btn-secondary" id="fitBrazilBtn"><i class="fas fa-globe-americas"></i> Ver todo Brasil</button>
                    <span class="source-tag source-tag-live"><i class="fas fa-map-pin"></i> <span id="mapMarkersCount">0</span> helic√≥pteros no mapa</span>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>¬© 2025 HeliTrack Brasil - Dados: RapidAPI (ADS-B Exchange) | üáßüá∑ Limitado ao espa√ßo a√©reo brasileiro</p>
            <p style="font-size: 0.7rem; margin-top: 5px;">App: default-application_11568714 | X-RapidAPI-Key: e09f3391demsh1953622dc1b4488p1f57f1jsn9ea218884ae1</p>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        (function() {
            // CONFIGURA√á√ïES DA RAPIDAPI
            const RAPIDAPI_CONFIG = {
                key: 'e09f3391demsh1953622dc1b4488p1f57f1jsn9ea218884ae1',
                host: 'adsbexchange-com1.p.rapidapi.com',
                baseUrl: 'https://adsbexchange-com1.p.rapidapi.com'
            };
            
            const UPDATE_INTERVAL = 30000; // 30 segundos
            
            // Limites geogr√°ficos do Brasil (aproximados)
            const BRAZIL_BOUNDS = {
                minLat: -34.0,  // Sul (Chu√≠)
                maxLat: 5.5,    // Norte (Monte Cabura√≠)
                minLon: -74.0,  // Oeste (Acre)
                maxLon: -34.0   // Leste (Para√≠ba)
            };
            
            // Regi√µes do Brasil (coordenadas aproximadas)
            const REGIONS = {
                southeast: { minLat: -25.5, maxLat: -14.5, minLon: -53.0, maxLon: -39.0, name: 'Sudeste' },
                south: { minLat: -34.0, maxLat: -25.5, minLon: -58.0, maxLon: -48.0, name: 'Sul' },
                northeast: { minLat: -16.0, maxLat: 5.5, minLon: -48.0, maxLon: -34.0, name: 'Nordeste' },
                north: { minLat: -16.0, maxLat: 5.5, minLon: -74.0, maxLon: -48.0, name: 'Norte' },
                centerwest: { minLat: -25.5, maxLat: -16.0, minLon: -62.0, maxLon: -48.0, name: 'Centro-Oeste' },
                offshore: { lat: -22.5, lon: -40.5, radius: 300, name: 'Offshore' } // Bacia de Campos/Santos
            };
            
            // Lista de modelos de helic√≥ptero para filtro
            const HELICOPTER_MODELS = [
                'AS350', 'H145', 'AW139', 'S76', 'BELL 407', 'BELL 429', 'EC135', 'R44', 'R66',
                'AS355', 'BK117', 'BO105', 'EC145', 'AW109', 'AW119', 'MD902', 'SA315', 'SA330',
                'UH60', 'S92', 'CH47', 'MI8', 'MI17', 'KA32', 'EC225', 'AS332', 'H125', 'H130'
            ];
            
            // Palavras-chave para identificar helic√≥pteros
            const HELICOPTER_KEYWORDS = [
                'helicopter', 'heli', 'rotor', 'as350', 'h145', 'aw139', 's76', 'bell', 
                'ec135', 'ec145', 'bk117', 'bo105', 'r44', 'r22', 'robinson', 'airbus helicopter',
                'esquilo', 'fennec', 'puma', 'super puma', 'black hawk', 'jayhawk', 'seahawk',
                'osprey', 'kiowa', 'cayuse', 'squirrel', 'colibri', 'eurocopter', 'md500',
                'defender', 'jetranger', 'longranger', 'astar', 'squirrel', 'dauphin',
                'panther', 'cougar', 'caracal', 'chinook', 'sea king', 'kaman', 'kamov'
            ];
            
            // Estado da aplica√ß√£o
            let allHelicopters = [];
            let filteredHelicopters = [];
            let lastUpdate = null;
            let updateTimer = null;
            let map = null;
            let mapMarkers = [];
            let apiStatus = 'disconnected';
            
            // Elementos DOM
            const tableBody = document.getElementById('tableBody');
            const resultSpan = document.getElementById('resultCount');
            const loadingEl = document.getElementById('loading');
            const tableContainer = document.getElementById('tableContainer');
            const mapContainer = document.getElementById('mapContainer');
            const lastUpdateSpan = document.getElementById('lastUpdateTime');
            const totalHelicoptersSpan = document.getElementById('totalHelicopters');
            const withPositionSpan = document.getElementById('withPosition');
            const totalOperatorsSpan = document.getElementById('totalOperators');
            const inFlightSpan = document.getElementById('inFlight');
            const activeFlightsBadge = document.getElementById('activeFlightsBadge');
            const mapMarkersCount = document.getElementById('mapMarkersCount');
            const apiStatusEl = document.getElementById('apiStatus');
            
            // Filtros
            const callsignFilter = document.getElementById('callsignFilter');
            const modelFilter = document.getElementById('modelFilter');
            const regionFilter = document.getElementById('regionFilter');
            const altitudeFilter = document.getElementById('altitudeFilter');
            const speedFilter = document.getElementById('speedFilter');
            const statusFilter = document.getElementById('statusFilter');
            
            // Fun√ß√£o para atualizar status da API
            function updateApiStatus(status, message) {
                apiStatus = status;
                if (status === 'connected') {
                    apiStatusEl.innerHTML = '<i class="fas fa-wifi"></i> RapidAPI Online';
                    apiStatusEl.className = 'badge api-status connected';
                } else if (status === 'error') {
                    apiStatusEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message || 'Erro na API'}`;
                    apiStatusEl.className = 'badge api-status error';
                } else {
                    apiStatusEl.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Conectando...';
                    apiStatusEl.className = 'badge api-status';
                }
            }
            
            // Fun√ß√£o para verificar se coordenada est√° no Brasil
            function isInBrazil(lat, lon) {
                if (!lat || !lon) return false;
                return lat >= BRAZIL_BOUNDS.minLat && 
                       lat <= BRAZIL_BOUNDS.maxLat && 
                       lon >= BRAZIL_BOUNDS.minLon && 
                       lon <= BRAZIL_BOUNDS.maxLon;
            }
            
            // Fun√ß√£o para determinar regi√£o do Brasil
            function getRegion(lat, lon) {
                if (!lat || !lon) return 'unknown';
                
                for (const [key, region] of Object.entries(REGIONS)) {
                    if (key === 'offshore') {
                        const distance = Math.sqrt(
                            Math.pow(lat - region.lat, 2) + 
                            Math.pow(lon - region.lon, 2)
                        ) * 111;
                        if (distance < region.radius) return 'offshore';
                    } else {
                        if (lat >= region.minLat && lat <= region.maxLat && 
                            lon >= region.minLon && lon <= region.maxLon) {
                            return key;
                        }
                    }
                }
                return 'unknown';
            }
            
            // Fun√ß√£o para verificar se √© um helic√≥ptero
            function isHelicopter(aircraft) {
                // Verifica pelo tipo de aeronave (se dispon√≠vel)
                if (aircraft.type && aircraft.type.toLowerCase().includes('helicopter')) {
                    return true;
                }
                
                // Verifica pela categoria
                if (aircraft.category && (aircraft.category === 'H' || aircraft.category === 'Helicopter')) {
                    return true;
                }
                
                // Verifica pelo modelo
                if (aircraft.t) {
                    const modelLower = aircraft.t.toLowerCase();
                    if (HELICOPTER_KEYWORDS.some(keyword => modelLower.includes(keyword))) {
                        return true;
                    }
                    
                    // Verifica modelos espec√≠ficos
                    if (HELICOPTER_MODELS.some(model => 
                        modelLower.includes(model.toLowerCase()) || 
                        modelLower.includes(model.replace(' ', '').toLowerCase())
                    )) {
                        return true;
                    }
                }
                
                // Verifica prefixos brasileiros de helic√≥ptero
                if (aircraft.flight) {
                    const callsign = aircraft.flight.trim().toUpperCase();
                    // Prefixos brasileiros: PR-XXX, PT-XXX, PP-XXX, PU-XXX (helic√≥pteros)
                    if (/^P[RTPU]-\w{3}$/.test(callsign)) {
                        return true;
                    }
                    
                    // Operadoras de helic√≥ptero conhecidas
                    const heliOperators = ['OMNI', 'LIDER', 'HELI', 'CHC', 'VAST', 'APUI', 'ROTA', 'SARA'];
                    if (heliOperators.some(op => callsign.startsWith(op))) {
                        return true;
                    }
                }
                
                // Verifica pelo n√∫mero ICAO (alguns padr√µes podem indicar helic√≥pteros)
                if (aircraft.hex && aircraft.hex.startsWith('A')) { // Prefixo brasileiro A para helic√≥pteros?
                    return true;
                }
                
                return false;
            }
            
            // Fun√ß√£o para buscar dados da RapidAPI
            async function fetchHelicopters() {
                try {
                    updateApiStatus('connecting');
                    loadingEl.style.display = 'block';
                    tableContainer.style.opacity = '0.5';
                    
                    // Construindo a URL para buscar todos os voos
                    // Nota: Voc√™ pode ajustar os par√¢metros conforme necess√°rio
                    const url = `${RAPIDAPI_CONFIG.baseUrl}/v2/aircraft/`;
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'X-RapidAPI-Key': RAPIDAPI_CONFIG.key,
                            'X-RapidAPI-Host': RAPIDAPI_CONFIG.host
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data || !data.aircraft || !Array.isArray(data.aircraft)) {
                        throw new Error('Formato de dados inv√°lido da API');
                    }
                    
                    // Filtrar helic√≥pteros que est√£o no Brasil
                    const potentialHelicopters = data.aircraft.filter(isHelicopter);
                    
                    // Filtrar apenas os que est√£o no Brasil (quando t√™m posi√ß√£o)
                    const helicoptersInBrazil = potentialHelicopters.filter(ac => {
                        if (ac.lat && ac.lon) {
                            return isInBrazil(ac.lat, ac.lon);
                        }
                        // Se n√£o tem posi√ß√£o, mant√©m (podem estar no Brasil)
                        return true;
                    });
                    
                    allHelicopters = helicoptersInBrazil;
                    lastUpdate = new Date();
                    
                    // Adiciona informa√ß√£o de regi√£o para cada helic√≥ptero
                    allHelicopters.forEach(ac => {
                        if (ac.lat && ac.lon) {
                            ac.region = getRegion(ac.lat, ac.lon);
                        } else {
                            ac.region = 'unknown';
                        }
                    });
                    
                    updateApiStatus('connected', 'Online');
                    updateStats();
                    applyFilters();
                    
                    console.log(`Encontrados ${allHelicopters.length} helic√≥pteros no Brasil via RapidAPI`);
                    
                } catch (error) {
                    console.error('Erro ao buscar dados da RapidAPI:', error);
                    updateApiStatus('error', error.message);
                    
                    tableBody.innerHTML = `<tr><td colspan="10" style="text-align:center; padding:40px; color: #dc3545;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>Erro ao carregar dados da RapidAPI: ${error.message}</p>
                        <p style="margin-top: 10px;">
                            <button class="btn btn-primary" onclick="window.location.reload()">
                                <i class="fas fa-redo"></i> Tentar novamente
                            </button>
                        </p>
                        <p style="margin-top: 15px; font-size: 0.9rem;">
                            Verifique sua chave de API e conex√£o com internet.
                        </p>
                    </td></tr>`;
                } finally {
                    loadingEl.style.display = 'none';
                    tableContainer.style.opacity = '1';
                }
            }
            
            // Atualiza estat√≠sticas
            function updateStats() {
                const total = allHelicopters.length;
                const withPos = allHelicopters.filter(ac => ac.lat && ac.lon).length;
                const inFlight = allHelicopters.filter(ac => ac.alt_baro && ac.alt_baro !== 'ground').length;
                
                // Operadoras √∫nicas (baseado em flight ou operador)
                const operators = new Set();
                allHelicopters.forEach(ac => {
                    if (ac.flight) operators.add(ac.flight.substring(0, 4));
                    if (ac.ownOp) operators.add(ac.ownOp);
                });
                
                totalHelicoptersSpan.textContent = total;
                withPositionSpan.textContent = withPos;
                totalOperatorsSpan.textContent = operators.size;
                inFlightSpan.textContent = inFlight;
                
                activeFlightsBadge.innerHTML = `<i class="fas fa-satellite-dish"></i> ${total} helic√≥pteros no Brasil`;
                
                if (lastUpdate) {
                    const timeStr = lastUpdate.toLocaleTimeString('pt-BR');
                    lastUpdateSpan.textContent = timeStr;
                }
            }
            
            // Aplica filtros
            function applyFilters() {
                const callsign = callsignFilter.value.trim().toUpperCase();
                const model = modelFilter.value;
                const region = regionFilter.value;
                const altitude = altitudeFilter.value;
                const speed = speedFilter.value;
                const status = statusFilter.value;
                
                filteredHelicopters = allHelicopters.filter(ac => {
                    // Filtro por callsign
                    if (callsign && (!ac.flight || !ac.flight.toUpperCase().includes(callsign))) {
                        return false;
                    }
                    
                    // Filtro por modelo
                    if (model && (!ac.t || !ac.t.toLowerCase().includes(model.toLowerCase()))) {
                        return false;
                    }
                    
                    // Filtro por regi√£o
                    if (region && region !== 'all' && ac.region !== region) {
                        return false;
                    }
                    
                    // Filtro por altitude
                    const alt = ac.alt_baro && ac.alt_baro !== 'ground' ? parseInt(ac.alt_baro) : 0;
                    if (altitude === 'ground' && alt !== 0) return false;
                    if (altitude === 'low' && (alt <= 0 || alt > 1000)) return false;
                    if (altitude === 'medium' && (alt < 1000 || alt > 5000)) return false;
                    if (altitude === 'high' && alt < 5000) return false;
                    
                    // Filtro por velocidade
                    const gs = ac.gs || 0;
                    if (speed === 'hover' && gs > 5) return false;
                    if (speed === 'slow' && (gs < 5 || gs > 50)) return false;
                    if (speed === 'cruise' && (gs < 50 || gs > 120)) return false;
                    if (speed === 'fast' && gs < 120) return false;
                    
                    // Filtro por status
                    const isFlying = ac.alt_baro && ac.alt_baro !== 'ground';
                    if (status === 'flying' && !isFlying) return false;
                    if (status === 'ground' && isFlying) return false;
                    
                    return true;
                });
                
                updateTable();
                updateMap();
            }
            
            // Atualiza tabela com dados filtrados
            function updateTable() {
                tableBody.innerHTML = '';
                resultSpan.textContent = `(${filteredHelicopters.length})`;
                
                if (filteredHelicopters.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:40px;">Nenhum helic√≥ptero encontrado no Brasil com os filtros selecionados.</td></tr>';
                    return;
                }
                
                filteredHelicopters.slice(0, 50).forEach(ac => {
                    const row = document.createElement('tr');
                    
                    const callsign = ac.flight || 'N/A';
                    const icao = ac.hex || 'N/A';
                    const model = ac.t || 'Desconhecido';
                    const operator = ac.ownOp || (ac.flight ? ac.flight.substring(0, 4) : 'N/A');
                    
                    let altitude = 'Em solo';
                    let altClass = '';
                    if (ac.alt_baro && ac.alt_baro !== 'ground') {
                        altitude = `${ac.alt_baro} ft`;
                        altClass = 'status-flying';
                    }
                    
                    const speed = ac.gs ? `${ac.gs} kt` : 'N/A';
                    const track = ac.track ? `${ac.track}¬∞` : 'N/A';
                    
                    let position = 'N/A';
                    if (ac.lat && ac.lon) {
                        position = `${ac.lat.toFixed(2)}¬∞, ${ac.lon.toFixed(2)}¬∞`;
                    }
                    
                    const region = ac.region !== 'unknown' ? 
                        REGIONS[ac.region]?.name || ac.region : 'N√£o identificada';
                    
                    const status = (ac.alt_baro && ac.alt_baro !== 'ground') ? 
                        '<span class="flight-status status-flying"><i class="fas fa-helicopter"></i> Em voo</span>' : 
                        '<span class="flight-status status-ground"><i class="fas fa-plane"></i> Em solo</span>';
                    
                    row.innerHTML = `
                        <td><strong>${callsign}</strong></td>
                        <td><code>${icao}</code></td>
                        <td>${model}</td>
                        <td>${operator}</td>
                        <td><span class="${altClass}">${altitude}</span></td>
                        <td>${speed}</td>
                        <td>${track}</td>
                        <td><small>${position}</small></td>
                        <td>${region}</td>
                        <td>${status}</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                if (filteredHelicopters.length > 50) {
                    const more = document.createElement('tr');
                    more.innerHTML = `<td colspan="10" style="text-align:center; background: #f9f9f9;"><i class="fas fa-ellipsis-h"></i> Mais ${filteredHelicopters.length - 50} helic√≥pteros ocultos. Refine os filtros para visualizar.</td>`;
                    tableBody.appendChild(more);
                }
            }
            
            // Inicializa mapa
            function initMap() {
                if (map) return;
                
                map = L.map('map').setView([-14.2350, -51.9253], 4); // Centro do Brasil
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
                
                // Adiciona limite do Brasil
                const bounds = L.latLngBounds(
                    [BRAZIL_BOUNDS.minLat, BRAZIL_BOUNDS.minLon],
                    [BRAZIL_BOUNDS.maxLat, BRAZIL_BOUNDS.maxLon]
                );
                L.rectangle(bounds, {
                    color: "#002776",
                    weight: 2,
                    fill: false,
                    dashArray: '5, 5'
                }).addTo(map).bindTooltip('Espa√ßo A√©reo Brasileiro', { permanent: false });
            }
            
            // Atualiza mapa com marcadores
            function updateMap() {
                if (!map) return;
                
                // Remove marcadores antigos
                mapMarkers.forEach(marker => marker.remove());
                mapMarkers = [];
                
                // Adiciona novos marcadores
                const withPosition = filteredHelicopters.filter(ac => ac.lat && ac.lon);
                mapMarkersCount.textContent = withPosition.length;
                
                withPosition.forEach(ac => {
                    const isFlying = ac.alt_baro && ac.alt_baro !== 'ground';
                    const icon = L.divIcon({
                        html: `<i class="fas fa-helicopter" style="color: ${isFlying ? '#28a745' : '#6c757d'}; font-size: 20px; text-shadow: 2px 2px 2px rgba(0,0,0,0.1);"></i>`,
                        className: 'helicopter-marker',
                        iconSize: [20, 20]
                    });
                    
                    const marker = L.marker([ac.lat, ac.lon], { icon }).addTo(map);
                    
                    const callsign = ac.flight || 'N/A';
                    const model = ac.t || 'Desconhecido';
                    const alt = ac.alt_baro && ac.alt_baro !== 'ground' ? `${ac.alt_baro} ft` : 'Em solo';
                    const speed = ac.gs ? `${ac.gs} kt` : 'N/A';
                    
                    marker.bindPopup(`
                        <div style="font-family: 'Inter', sans-serif;">
                            <b style="color: #0066b3;">${callsign}</b><br>
                            <small>ICAO: ${ac.hex}</small><br>
                            <hr style="margin: 5px 0;">
                            <i class="fas fa-cog"></i> ${model}<br>
                            <i class="fas fa-arrow-up"></i> ${alt}<br>
                            <i class="fas fa-tachometer-alt"></i> ${speed}<br>
                            <i class="fas fa-map-pin"></i> ${ac.lat.toFixed(4)}¬∞, ${ac.lon.toFixed(4)}¬∞
                        </div>
                    `);
                    
                    mapMarkers.push(marker);
                });
            }
            
            // Event listeners
            document.getElementById('searchBtn').addEventListener('click', applyFilters);
            
            document.getElementById('clearBtn').addEventListener('click', function() {
                callsignFilter.value = '';
                modelFilter.value = '';
                regionFilter.value = '';
                altitudeFilter.value = 'all';
                speedFilter.value = 'all';
                statusFilter.value = 'all';
                applyFilters();
            });
            
            document.getElementById('refreshBtn').addEventListener('click', function() {
                fetchHelicopters();
            });
            
            document.getElementById('fitBrazilBtn').addEventListener('click', function() {
                if (map) {
                    map.setView([-14.2350, -51.9253], 4);
                }
            });
            
            // Troca de visualiza√ß√£o
            document.getElementById('gridViewBtn').addEventListener('click', function() {
                tableContainer.style.display = 'block';
                mapContainer.style.display = 'none';
                document.getElementById('gridViewBtn').classList.add('active');
                document.getElementById('mapViewBtn').classList.remove('active');
            });
            
            document.getElementById('mapViewBtn').addEventListener('click', function() {
                tableContainer.style.display = 'none';
                mapContainer.style.display = 'block';
                document.getElementById('mapViewBtn').classList.add('active');
                document.getElementById('gridViewBtn').classList.remove('active');
                
                if (!map) {
                    initMap();
                    setTimeout(updateMap, 100);
                } else {
                    updateMap();
                }
            });
            
            // Atualiza√ß√£o autom√°tica
            function startAutoUpdate() {
                if (updateTimer) clearInterval(updateTimer);
                updateTimer = setInterval(fetchHelicopters, UPDATE_INTERVAL);
            }
            
            // Carrega dados iniciais
            fetchHelicopters();
            startAutoUpdate();
            
            // Enter no campo de callsign
            callsignFilter.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') applyFilters();
            });
            
            // Carregar modelos no select (opcional)
            function populateModelSelect() {
                // Voc√™ pode adicionar mais modelos aqui se necess√°rio
                const modelSelect = document.getElementById('modelFilter');
                HELICOPTER_MODELS.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });
            }
            
            // Descomente se quiser popular automaticamente
            // populateModelSelect();
            
        })();
    </script>
</body>
</html>